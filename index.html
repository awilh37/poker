<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPS 2.0 Login</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and overall body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Ensure padding doesn't cause overflow */
        }
        /* Style for the message box (e.g., error/success messages) */
        .message-box {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        .message-box.error {
            background-color: #fee2e2; /* Red-ish background */
            color: #ef4444; /* Red text */
            border: 1px solid #ef4444;
        }
        .message-box.success {
            background-color: #d1fae5; /* Green-ish background */
            color: #10b981; /* Green text */
            border: 1px solid #10b981;
        }
        .message-box.info {
            background-color: #bfdbfe; /* Blue-ish background */
            color: #3b82f6; /* Blue text */
            border: 1px solid #3b82f6;
        }
        /* Styling for log entries */
        .log-entry {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #4b5563;
            text-align: left;
        }
        .log-entry strong {
            color: #1f2937;
        }
        /* Table styles for user management */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .user-table th, .user-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: left;
        }
        .user-table th {
            background-color: #e0f2fe;
            color: #2563eb;
            font-weight: bold;
        }
        .user-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .user-table select {
            width: 100%;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
        }
    </style>
</head>
<body class="bg-gray-100 font-inter">

    <!-- Main Login Container -->
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm flex flex-col items-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">WPS Login</h2>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden flex items-center justify-center p-4">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600">Initializing Firebase...</span>
        </div>

        <!-- Login Buttons -->
        <div id="loginButtonsContainer" class="w-full flex flex-col items-center space-y-3 hidden">
            <button
                type="button"
                id="googleLoginButton"
                class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
            >
                <!-- Google Icon SVG -->
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.0001 4.5V7.5L17.2501 7.5C17.0279 8.65312 16.3989 9.69736 15.4883 10.4514C14.5776 11.2054 13.4357 11.6212 12.2501 11.6212C9.40006 11.6212 6.99999 9.40871 6.99999 6.55871C6.99999 3.70871 9.40006 1.49621 12.2501 1.49621C13.6874 1.49621 14.9754 2.05267 15.9388 2.92305L18.1565 0.705359C16.5912 -0.80332 14.4754 -1.54716e-07 12.2501 -1.54716e-07C7.26627 -1.54716e-07 3.00006 4.26627 3.00006 9.25006C3.00006 14.2338 7.26627 18.5 12.2501 18.5C14.6738 18.5 16.6346 17.6534 18.0626 16.1436C19.5398 14.6338 19.9999 12.3501 19.9999 9.94006C19.9999 9.25006 19.9312 8.57506 19.8001 7.92506L12.0001 7.92506V4.5Z" fill="#fff"/>
                </svg>
                Sign In with Google
            </button>
            <button
                type="button"
                id="emailPasswordLoginButton"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
            >
                Sign In with Email/Password (Placeholder)
            </button>
        </div>


        <!-- Message Box for Login Status -->
        <div id="messageBox" class="message-box hidden w-full"></div>

        <!-- Logout Button (Initially hidden) -->
        <button
            id="logoutButton"
            class="hidden mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
        >
            Logout
        </button>

        <!-- Admin Panel (Initially hidden) -->
        <div id="adminPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full text-center">
            <h3 class="text-2xl font-bold text-gray-700 mb-4">Admin Panel</h3>
            <p class="text-gray-600 mb-6">
                Welcome, Administrator! From here, you can manage users, game data, and other aspects of the WPS system.
                <br>
                <strong class="text-red-500">Note: User management will only show users who have logged in via Firebase Auth.</strong>
            </p>
            <div class="space-y-4">
                <button id="manageUsersButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Manage Users
                </button>
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Manage Game Data
                </button>
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Configure Games
                </button>
                <button id="viewLogsButton" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    View Activity Logs
                </button>
                <button id="manageAccountButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Account Management
                </button>
            </div>
        </div>

        <!-- User Management Panel (Initially hidden) -->
        <div id="userManagementPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md">
            <h3 class="text-2xl font-bold text-gray-700 mb-4 text-center">User Management</h3>
            <p class="text-gray-600 mb-4 text-center">
                Assign roles to users who have logged in.
                <br>
                <strong class="text-red-500">Important: This is a client-side role management for demonstration. For production, consider using Firebase Cloud Functions for secure role assignment.</strong>
            </p>
            <div class="overflow-x-auto">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>User ID (UID)</th>
                            <th>Email</th>
                            <th>Role</th>
                        </tr>
                    </thead>
                    <tbody id="userRolesTableBody">
                        <!-- User rows will be rendered here -->
                        <tr><td colspan="3" class="text-center text-gray-500">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex justify-between space-x-2 mt-4">
                <button id="saveUserRolesButton" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Save Roles
                </button>
                <button id="hideUserManagementButton" class="w-1/2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Hide Panel
                </button>
            </div>
        </div>

        <!-- Account Management Panel (Initially hidden) -->
        <div id="accountManagementPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md text-center">
            <h3 class="text-2xl font-bold text-gray-700 mb-4">Account Management</h3>
            <div class="flex flex-col items-center space-y-4">
                <img id="userProfilePic" class="w-24 h-24 rounded-full border-4 border-blue-400 shadow-md" src="" alt="Profile Picture">
                <p class="text-xl font-semibold text-gray-800" id="currentUserName"></p>
                <p class="text-gray-600" id="currentUserUsername"></p>
                <p class="text-gray-500 text-sm" id="currentUserProvider"></p>

                <div class="w-full space-y-3 pt-4 border-t border-gray-200 mt-4">
                    <button
                        type="button"
                        id="linkGoogleAccountButton"
                        class="w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
                    >
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.0001 4.5V7.5L17.2501 7.5C17.0279 8.65312 16.3989 9.69736 15.4883 10.4514C14.5776 11.2054 13.4357 11.6212 12.2501 11.6212C9.40006 11.6212 6.99999 9.40871 6.99999 6.55871C6.99999 3.70871 9.40006 1.49621 12.2501 1.49621C13.6874 1.49621 14.9754 2.05267 15.9388 2.92305L18.1565 0.705359C16.5912 -0.80332 14.4754 -1.54716e-07 12.2501 -1.54716e-07C7.26627 -1.54716e-07 3.00006 4.26627 3.00006 9.25006C3.00006 14.2338 7.26627 18.5 12.2501 18.5C14.6738 18.5 16.6346 17.6534 18.0626 16.1436C19.5398 14.6338 19.9999 12.3501 19.9999 9.94006C19.9999 9.25006 19.9312 8.57506 19.8001 7.92506L12.0001 7.92506V4.5Z" fill="#fff"/>
                        </svg>
                        Link with Google
                    </button>
                    <button class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                        Change Password (Placeholder)
                    </button>
                    <button class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                        Update Profile (Placeholder)
                    </button>
                </div>
                <button id="hideAccountManagementButton" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Close Account Management
                </button>
            </div>
        </div>


        <!-- Activity Log Viewer (Initially hidden) -->
        <div id="logViewer" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md">
            <h3 class="text-2xl font-bold text-gray-700 mb-4 text-center">Activity Logs</h3>

            <!-- Log Filters and Sort -->
            <div class="flex flex-wrap items-center justify-between mb-4 space-y-2 md:space-y-0">
                <div class="w-full md:w-1/2 pr-0 md:pr-2">
                    <label for="logFilterType" class="block text-gray-700 text-sm font-semibold mb-1">Filter by Type:</label>
                    <select id="logFilterType" class="w-full border rounded-lg py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Types</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="w-full md:w-1/2 pl-0 md:pl-2">
                    <label for="logSearchText" class="block text-gray-700 text-sm font-semibold mb-1">Search Text:</label>
                    <input type="text" id="logSearchText" placeholder="Search logs..." class="w-full border rounded-lg py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="w-full mt-3">
                    <label class="block text-gray-700 text-sm font-semibold mb-1">Sort Order:</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="logSortOrder" value="newest" checked class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Newest First</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="logSortOrder" value="oldest" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Oldest First</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="logEntries" class="max-h-60 overflow-y-auto border border-gray-200 p-2 rounded-lg bg-white mb-4">
                <!-- Log entries will be rendered here -->
                <p class="text-gray-500 text-center">No logs yet.</p>
            </div>
            <div class="flex justify-between space-x-2">
                <button id="clearLogsButton" class="w-1/2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Clear Logs
                </button>
                <button id="hideLogsButton" class="w-1/2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Hide Logs
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, linkWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBefsHEBuiRyJ31NzF885ac3ugCefzngTU",
            authDomain: "wps-3-be723.firebaseapp.com",
            projectId: "wps-3-be723",
            storageBucket: "wps-3-be723.firebasestorage.app",
            messagingSenderId: "420146617877",
            appId: "1:420146617877:web:ea2e06a690732da76fb81c",
            measurementId: "G-H0Z4C2185Y"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const analytics = getAnalytics(firebaseApp);
        const db = getFirestore(firebaseApp, 'wps-database'); // Using named database 'wps-database'
        const auth = getAuth(firebaseApp);
        const googleProvider = new GoogleAuthProvider();


        // Track Firebase authentication readiness and data loading state
        let firebaseAuthReady = false;
        let isLoggingOut = false;
        let dataLoadedAndListenersSetup = false;


        // --- Super Admin UID (DO NOT TOUCH THIS!) ---
        // This UID will be used to identify the initial administrator account.
        // It should be the Firebase UID of your Google account.
        const SUPER_ADMIN_UID = "Qr3XI0uNYrZ3AECim6XtRvp12MJ2";


        // --- DOM Elements ---
        const loginButtonsContainer = document.getElementById('loginButtonsContainer');
        const googleLoginButton = document.getElementById('googleLoginButton');
        const emailPasswordLoginButton = document.getElementById('emailPasswordLoginButton');
        const messageBox = document.getElementById('messageBox');
        const logoutButton = document.getElementById('logoutButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const adminPanel = document.getElementById('adminPanel');

        const manageUsersButton = document.getElementById('manageUsersButton');
        const userManagementPanel = document.getElementById('userManagementPanel');
        const userRolesTableBody = document.getElementById('userRolesTableBody');
        const saveUserRolesButton = document.getElementById('saveUserRolesButton');
        const hideUserManagementButton = document.getElementById('hideUserManagementButton');

        const viewLogsButton = document.getElementById('viewLogsButton');
        const logViewer = document.getElementById('logViewer');
        const logEntriesContainer = document.getElementById('logEntries');
        const clearLogsButton = document.getElementById('clearLogsButton');
        const hideLogsButton = document.getElementById('hideLogsButton');

        const manageAccountButton = document.getElementById('manageAccountButton');
        const accountManagementPanel = document.getElementById('accountManagementPanel');
        const userProfilePic = document.getElementById('userProfilePic');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserUsername = document.getElementById('currentUserUsername');
        const currentUserProvider = document.getElementById('currentUserProvider');
        const linkGoogleAccountButton = document.getElementById('linkGoogleAccountButton');
        const hideAccountManagementButton = document.getElementById('hideAccountManagementButton');


        const logFilterType = document.getElementById('logFilterType');
        const logSearchText = document.getElementById('logSearchText');
        const logSortOrderRadios = document.querySelectorAll('input[name="logSortOrder"]');

        let allFirebaseUsersData = []; // Stores user profiles fetched from Firestore
        let firestoreUserRoles = {}; // Stores roles fetched from Firestore
        let firestoreActivityLogs = []; // Stores logs fetched from Firestore

        const ROLES = ['Member', 'Moderator', 'Admin', 'Banned']; // Defined roles for the system

        // Firestore Collection References (implicitly pointing to 'user-data' database)
        const userRolesCollectionRef = collection(db, `artifacts/${appId}/public/data/user_roles`);
        const activityLogsCollectionRef = collection(db, `artifacts/${appId}/public/data/activity_logs`);
        const userProfilesCollectionRef = collection(db, `artifacts/${appId}/public/data/user_profiles`);


        // --- Utility Functions ---
        function showPanel(panelToShow) {
            const panels = [loginButtonsContainer, adminPanel, userManagementPanel, logViewer, accountManagementPanel, loadingIndicator];
            panels.forEach(panel => {
                if (panel === panelToShow) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
        }

        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type} w-full`;
            messageBox.classList.remove('hidden');
            setTimeout(hideMessage, 5000); // Auto-hide messages after 5 seconds
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }


        // --- Log System Functions (Firestore Integrated) ---
        async function addLogEntry(action, details = {}) {
            const timestamp = new Date().toISOString();
            const log = {
                timestamp: timestamp,
                action: action,
                ...details
            };
            try {
                // Ensure auth.currentUser exists before attempting to log to Firestore
                if (auth.currentUser && auth.currentUser.uid) {
                    await addDoc(activityLogsCollectionRef, log);
                    console.log("Log added to Firestore:", log);
                } else {
                    console.warn("Firebase Auth not ready or user not authenticated. Logged locally (backup):", log);
                    // Fallback to local storage for logs if Firebase Auth isn't ready
                    const logs = JSON.parse(localStorage.getItem('activityLogsBackup') || '[]');
                    logs.push(log);
                    localStorage.setItem('activityLogsBackup', JSON.stringify(logs));
                }
            } catch (e) {
                console.error("Error saving log to Firestore:", e);
                // No showMessage here to avoid message box clutter on every log failure
            }
        }

        function populateLogFilterTypes() {
            const uniqueTypes = new Set(firestoreActivityLogs.map(log => log.action));
            logFilterType.innerHTML = '<option value="all">All Types</option>';
            uniqueTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                logFilterType.appendChild(option);
            });
        }

        function renderLogs() {
            logEntriesContainer.innerHTML = '';
            let logsToDisplay = [...firestoreActivityLogs];

            const selectedType = logFilterType.value;
            const searchText = logSearchText.value.toLowerCase();
            const sortOrder = document.querySelector('input[name="logSortOrder"]:checked').value;

            let filteredLogs = logsToDisplay.filter(log => {
                const matchesType = selectedType === 'all' || log.action === selectedType;
                const logContent = JSON.stringify(log).toLowerCase();
                const matchesText = logContent.includes(searchText);
                return matchesType && matchesText;
            });

            filteredLogs.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                if (sortOrder === 'newest') {
                    return dateB.getTime() - dateA.getTime();
                } else {
                    return dateA.getTime() - dateB.getTime();
                }
            });

            if (filteredLogs.length === 0) {
                logEntriesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No matching logs found.</p>';
                return;
            }

            filteredLogs.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-entry';
                let detailsHtml = '';
                for (const key in log) {
                    if (key !== 'timestamp' && key !== 'action' && key !== 'id') {
                        detailsHtml += ` <strong>${key}:</strong> ${log[key]};`;
                    }
                }
                logDiv.innerHTML = `<strong>[${new Date(log.timestamp).toLocaleString()}] ${log.action}:</strong>${detailsHtml}`;
                logEntriesContainer.appendChild(logDiv);
            });
        }

        async function clearLogs() {
             if (!confirm("Are you sure you want to clear ALL activity logs from Firestore? This cannot be undone.")) {
                return;
            }

            if (!auth.currentUser) {
                showMessage("You must be logged in to clear logs.", 'error');
                return;
            }

            showMessage("Clearing logs...", 'info');
            try {
                const querySnapshot = await getDocs(activityLogsCollectionRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                addLogEntry("Logs Cleared", { by: auth.currentUser.uid });
                showMessage('Activity logs cleared from Firestore.', 'success');
            } catch (e) {
                console.error("Error clearing logs from Firestore:", e);
                showMessage("Failed to clear logs from Firestore.", 'error');
            }
        }
        // --- End Log System Functions ---


        // --- User Management Functions (Firestore Integrated) ---
        async function saveUserRolesToFirestore(rolesMap) {
            if (!auth.currentUser || (auth.currentUser.uid !== SUPER_ADMIN_UID && firestoreUserRoles[auth.currentUser.uid]?.role !== 'admin')) {
                showMessage("You do not have permission to save user roles.", 'error');
                return;
            }

            showMessage("Saving user roles...", 'info');
            try {
                const oldRolesMap = firestoreUserRoles;

                for (const uid in rolesMap) {
                    const newRole = rolesMap[uid];
                    const docRef = doc(userRolesCollectionRef, uid);

                    if (oldRolesMap[uid]?.role !== newRole) { // Only update if role actually changed
                        await setDoc(docRef, { role: newRole }, { merge: true });
                        addLogEntry("User Role Changed", {
                            targetUser: uid,
                            oldRole: oldRolesMap[uid]?.role || 'Member',
                            newRole: newRole,
                            by: auth.currentUser.email || auth.currentUser.uid
                        });
                    }
                }
                showMessage("User roles saved to Firestore.", 'success');
            } catch (e) {
                console.error("Error saving user roles to Firestore:", e);
                showMessage("Failed to save user roles to Firestore.", 'error');
            }
        }

        function renderUserRolesTable() {
            userRolesTableBody.innerHTML = '';
            
            if (allFirebaseUsersData.length === 0) {
                userRolesTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No users found. Users will appear here after they log in.</td></tr>';
                return;
            }

            allFirebaseUsersData.forEach(user => {
                const row = userRolesTableBody.insertRow();
                const userIdCell = row.insertCell();
                const userEmailCell = row.insertCell();
                const userRoleCell = row.insertCell();

                userIdCell.textContent = user.uid; // Display UID
                userEmailCell.textContent = user.email || 'N/A'; // Display email

                const select = document.createElement('select');
                select.className = 'border rounded-lg p-1';
                select.setAttribute('data-uid', user.uid); // Use UID as data attribute

                ROLES.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    select.appendChild(option);
                });

                select.value = firestoreUserRoles[user.uid]?.role || 'Member'; // Set role from Firestore

                // Disable select for the super admin or if the current user is not admin
                if (user.uid === SUPER_ADMIN_UID || (auth.currentUser.uid !== SUPER_ADMIN_UID && firestoreUserRoles[auth.currentUser.uid]?.role !== 'admin')) {
                    select.disabled = true;
                }

                userRoleCell.appendChild(select);
            });
        }

        function collectAndSaveRoles() {
            const newRolesMap = {};
            const roleSelects = userRolesTableBody.querySelectorAll('select[data-uid]');

            roleSelects.forEach(select => {
                const uid = select.getAttribute('data-uid');
                const newRole = select.value;
                newRolesMap[uid] = newRole;
            });
            saveUserRolesToFirestore(newRolesMap);
        }
        // --- End User Management Functions ---


        // --- Account Management Functions ---
        function renderAccountManagementPanel(displayUser) {
            const firebaseUser = auth.currentUser;

            userProfilePic.src = displayUser.profilePic || firebaseUser?.photoURL || 'https://placehold.co/100x100/cccccc/ffffff?text=U';
            userProfilePic.alt = `${displayUser.name || displayUser.username}'s profile picture`;
            currentUserName.textContent = displayUser.name || firebaseUser?.displayName || 'N/A';
            currentUserUsername.textContent = `Email: ${displayUser.username || firebaseUser?.email || 'N/A'}`;

            let providerId = 'Unknown';
            if (firebaseUser) {
                const providers = firebaseUser.providerData.map(p => p.providerId);
                if (providers.includes('google.com')) {
                    providerId = 'Google';
                    linkGoogleAccountButton.classList.add('hidden'); // Already linked with Google
                } else if (providers.includes('password')) {
                    providerId = 'Email/Password';
                    linkGoogleAccountButton.classList.remove('hidden'); // Can link to Google
                } else if (providers.includes('anonymous')) {
                    providerId = 'Anonymous';
                    linkGoogleAccountButton.classList.remove('hidden'); // Can link to Google
                }
            } else {
                providerId = 'No Firebase Session'; // Should not happen if this panel is shown
                linkGoogleAccountButton.classList.remove('hidden');
            }
            currentUserProvider.textContent = `Provider: ${providerId}`;
        }

        async function handleGoogleLink() {
            if (!auth.currentUser) {
                showMessage("No active Firebase user session to link accounts. Please sign in first.", 'error');
                return;
            }

            showMessage("Attempting to link with Google...", 'info');
            try {
                const result = await linkWithPopup(auth.currentUser, googleProvider);
                const linkedUser = result.user;
                console.log("Account linked successfully with Google:", linkedUser);

                const updatedLoggedInUser = {
                    username: linkedUser.email || linkedUser.uid,
                    name: linkedUser.displayName || linkedUser.email,
                    profilePic: linkedUser.photoURL,
                    isAdmin: (linkedUser.uid === SUPER_ADMIN_UID || firestoreUserRoles[linkedUser.uid]?.role === 'admin'),
                    firebaseUid: linkedUser.uid
                };
                localStorage.setItem('loggedInUser', JSON.stringify(updatedLoggedInUser));
                
                showMessage("Account successfully linked with Google!", 'success');
                addLogEntry("Account Linked", { user: linkedUser.email || linkedUser.uid, provider: "Google" });
                renderAccountManagementPanel(updatedLoggedInUser);
            } catch (error) {
                console.error("Error linking Google account:", error);
                let errorMessage = "Failed to link Google account.";
                if (error.code === 'auth/credential-already-in-use') {
                    errorMessage = "This Google account is already linked to another user.";
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google login window was closed.";
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid Google credential or already linked to a different account.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "The email associated with this Google account is already in use by another login method. Please sign in with that method and then link.";
                }
                showMessage(errorMessage, 'error');
                addLogEntry("Account Link Failed", { user: auth.currentUser?.uid || 'Unknown', provider: "Google", error: error.message });
            }
        }

        // Function to handle successful login and subsequent data loading
        async function handleLoginSuccess(user) {
            console.log("handleLoginSuccess: User authenticated, UID:", user.uid);
            
            // Ensure data loading and listeners setup only once per successful login
            if (!dataLoadedAndListenersSetup) {
                showPanel(loadingIndicator); // Show loading indicator while data is fetched
                loadingIndicator.querySelector('span').textContent = 'Loading user data...';
                await loadInitialData(); // Load user profiles
                setupFirestoreListeners(); // Set up real-time listeners for roles and logs
                dataLoadedAndListenersSetup = true;
            }

            // Ensure a user profile exists in Firestore for the logged-in Firebase user
            // This is crucial to capture new users who log in for the first time
            if (user) {
                const userProfileRef = doc(userProfilesCollectionRef, user.uid);
                await setDoc(userProfileRef, {
                    uid: user.uid,
                    email: user.email || null,
                    displayName: user.displayName || null,
                    photoURL: user.photoURL || null,
                    lastLogin: new Date().toISOString(),
                    // Initialize role if it doesn't exist. This will be updated by the listener.
                    role: firestoreUserRoles[user.uid]?.role || 'Member'
                }, { merge: true });
                console.log("User profile updated/created in Firestore:", user.uid);
            }

            // After data is loaded and listeners are set up (and roles are synced),
            // determine the user's role and show the appropriate panel.
            const userRole = firestoreUserRoles[user.uid]?.role || 'Member';
            const isAdmin = (user.uid === SUPER_ADMIN_UID || userRole === 'admin');

            const finalUserForLocalStorage = {
                username: user.email || user.uid,
                name: user.displayName || user.email || 'Anonymous User',
                profilePic: user.photoURL || 'https://placehold.co/50x50/cccccc/ffffff?text=U',
                isAdmin: isAdmin,
                firebaseUid: user.uid,
                role: userRole
            };

            localStorage.setItem('loggedInUser', JSON.stringify(finalUserForLocalStorage));

            showMessage(`Welcome, ${finalUserForLocalStorage.name}!`, 'success');
            
            if (finalUserForLocalStorage.isAdmin) {
                showPanel(adminPanel);
                addLogEntry("Admin Login", { user: finalUserForLocalStorage.username, firebaseUid: user.uid });
            } else {
                showPanel(accountManagementPanel);
                renderAccountManagementPanel(finalUserForLocalStorage);
                addLogEntry("User Login", { user: finalUserForLocalStorage.username, firebaseUid: user.uid });
            }
            logoutButton.classList.remove('hidden');
        }

        // Function to handle logout
        async function handleLogout() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                addLogEntry("Logout", { user: user.username, isAdmin: user.isAdmin, firebaseUid: user.firebaseUid });
            } else {
                 addLogEntry("Logout", { user: "Unknown" });
            }

            isLoggingOut = true; 
            try {
                if (auth.currentUser) {
                    await signOut(auth); // Use Firebase signOut function
                    console.log("Firebase: Signed out.");
                }
            } catch (error) {
                console.error("Firebase: Error signing out:", error);
            }

            localStorage.removeItem('loggedInUser');
            dataLoadedAndListenersSetup = false; // Reset for next login
            showMessage('You have been logged out.', 'info');
            showPanel(loginButtonsContainer);
            logoutButton.classList.add('hidden');
        }

        // --- Initial Data Loading (fetches user profiles) ---
        async function loadInitialData() {
            console.log("loadInitialData: Attempting to load user profiles...");
            if (!auth.currentUser) {
                console.warn("loadInitialData: Skipping data load, no authenticated user.");
                return;
            }

            try {
                const querySnapshot = await getDocs(userProfilesCollectionRef);
                allFirebaseUsersData = [];
                querySnapshot.forEach(doc => {
                    allFirebaseUsersData.push(doc.data());
                });
                console.log("Loaded Firebase user profiles:", allFirebaseUsersData.length);
            } catch (error) {
                console.error("Failed to fetch user profiles:", error);
                showMessage(`Failed to load user data: ${error.message}.`, 'error');
                addLogEntry("Initial data load failed", { error: error.message });
            }
        }

        // --- Firestore Real-time Listeners (for user roles and activity logs) ---
        function setupFirestoreListeners() {
            console.log("setupFirestoreListeners: Attempting to set up listeners...");
            if (!auth.currentUser) {
                console.warn("setupFirestoreListeners: Skipping listener setup, no authenticated user.");
                return;
            }

            // Listen for changes in user roles
            onSnapshot(userRolesCollectionRef, (snapshot) => {
                const newRoles = {};
                snapshot.forEach(doc => {
                    newRoles[doc.id] = doc.data();
                });
                firestoreUserRoles = newRoles;
                console.log("Firestore: User Roles updated:", firestoreUserRoles);
                if (!userManagementPanel.classList.contains('hidden')) {
                    renderUserRolesTable();
                }
                const currentUser = auth.currentUser;
                if (currentUser) {
                    const storedUser = JSON.parse(localStorage.getItem('loggedInUser'));
                    if (storedUser) {
                         const currentRole = firestoreUserRoles[currentUser.uid]?.role || 'Member';
                         const isAdmin = (currentUser.uid === SUPER_ADMIN_UID || currentRole === 'admin');
                         if (storedUser.isAdmin !== isAdmin) {
                             console.log("Admin status changed, re-rendering UI.");
                             storedUser.isAdmin = isAdmin;
                             storedUser.role = currentRole;
                             localStorage.setItem('loggedInUser', JSON.stringify(storedUser));
                             // Re-evaluate current panel based on new admin status
                             if (isAdmin) {
                                showPanel(adminPanel);
                             } else {
                                showPanel(accountManagementPanel);
                                renderAccountManagementPanel(storedUser);
                             }
                         }
                    }
                }
            }, (error) => {
                console.error("Firestore: Error listening to user roles:", error);
                showMessage("Error: Could not sync user roles from cloud.", 'error');
            });

            // Listen for changes in user profiles (to update the user management table)
            onSnapshot(userProfilesCollectionRef, (snapshot) => {
                allFirebaseUsersData = [];
                snapshot.forEach(doc => {
                    allFirebaseUsersData.push(doc.data());
                });
                console.log("Firestore: User Profiles updated:", allFirebaseUsersData.length);
                if (!userManagementPanel.classList.contains('hidden')) {
                    renderUserRolesTable();
                }
            }, (error) => {
                console.error("Firestore: Error listening to user profiles:", error);
                showMessage("Error: Could not sync user profiles from cloud.", 'error');
            });

            // Listen for changes in activity logs
            onSnapshot(activityLogsCollectionRef, (snapshot) => {
                const newLogs = [];
                snapshot.forEach(doc => {
                    newLogs.push({ id: doc.id, ...doc.data() });
                });
                firestoreActivityLogs = newLogs;
                console.log("Firestore: Activity Logs updated:", firestoreActivityLogs.length, "entries");
                populateLogFilterTypes();
                renderLogs();
            }, (error) => {
                console.error("Firestore: Error listening to activity logs:", error);
                showMessage("Error: Could not sync activity logs from cloud.", 'error');
            });
        }


        // --- Initialize App on DOM Load and Auth State Change ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired. Script is running.');
            showPanel(loadingIndicator); // Show loading indicator immediately

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is authenticated
                    console.log("Firebase: Authenticated. User ID:", user.uid, "Provider:", user.providerData[0]?.providerId || 'N/A');
                    firebaseAuthReady = true;

                    // If not logging out, and data/listeners not yet set up for this session
                    if (!isLoggingOut && !dataLoadedAndListenersSetup) {
                        console.log("onAuthStateChanged: User present and not logging out, triggering handleLoginSuccess.");
                        await handleLoginSuccess(user); // Triggers data load, listener setup, and panel display
                    } else if (isLoggingOut) {
                        console.log("onAuthStateChanged: User present but in logging out state. Skipping automatic login actions.");
                        showPanel(loginButtonsContainer); // Ensure login buttons are shown after logout
                        logoutButton.classList.add('hidden');
                        isLoggingOut = false; // Reset flag
                    } else {
                        // User is authenticated and data/listeners already set up for this session
                        console.log("onAuthStateChanged: User authenticated, data already loaded. Showing appropriate panel.");
                        const storedUser = JSON.parse(localStorage.getItem('loggedInUser'));
                        if (storedUser && storedUser.isAdmin) {
                            showPanel(adminPanel);
                        } else if (storedUser) {
                            showPanel(accountManagementPanel);
                            renderAccountManagementPanel(storedUser);
                        } else {
                            // Fallback if localStorage is somehow out of sync with Firebase auth
                            showPanel(loginButtonsContainer);
                            logoutButton.classList.add('hidden');
                        }
                    }
                    googleLoginButton.disabled = false;
                    emailPasswordLoginButton.disabled = false;

                } else {
                    // No Firebase user is currently authenticated
                    console.log("Firebase: No user authenticated or user logged out.");
                    firebaseAuthReady = true; // Mark auth ready to allow future login attempts

                    if (initialAuthToken && !isLoggingOut) {
                        // Canvas environment: Attempt to sign in with custom token
                        console.log("Firebase: Canvas environment detected. Attempting custom token sign-in.");
                        loadingIndicator.querySelector('span').textContent = 'Authenticating with Canvas...';
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            // If successful, onAuthStateChanged will fire again with `user`, triggering data setup.
                        } catch (error) {
                            console.error("Firebase: Custom authentication failed:", error);
                            showMessage(`Firebase custom auth failed: ${error.message}. Functionality may be limited.`, 'error');
                            showPanel(loginButtonsContainer); // Show login buttons if custom auth fails
                        } finally {
                            loadingIndicator.classList.add('hidden');
                        }
                    } else {
                        // Regular web deployment or after explicit logout
                        console.log("Firebase: Regular deployment or logged out. Displaying login options.");
                        showPanel(loginButtonsContainer);
                        logoutButton.classList.add('hidden');
                        loadingIndicator.classList.add('hidden'); // Hide loading if no auth
                    }
                    // Reset data/listener flag when no user is authenticated
                    dataLoadedAndListenersSetup = false; 
                    googleLoginButton.disabled = false;
                    emailPasswordLoginButton.disabled = false;
                }
            });
        });

        // Event listener for Google Login Button (primary login method)
        googleLoginButton.addEventListener('click', async () => {
            console.log('Google Login button clicked.');
            addLogEntry("Google Login Attempt");

            if (!firebaseAuthReady) {
                showMessage("Firebase authentication is not ready yet. Please wait a moment and try again.", 'info');
                return;
            }
            
            googleLoginButton.disabled = true; // Disable button during login attempt
            showMessage("Signing in with Google...", 'info');
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user; // Firebase User object
                console.log("Google Sign-In successful:", user);

                await handleLoginSuccess(user); // Pass the Firebase User object directly
                addLogEntry("Google Login Success", { user: user.email || user.uid });

            } catch (error) {
                console.error("Google Sign-In failed:", error);
                let errorMessage = "Google sign-in failed.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google login window was closed.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Popup blocked or already open. Please try again.";
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                     errorMessage = `An account already exists with this email using a different login method.`;
                     console.warn(errorMessage, "Provider ID:", error.customData.email, error.credential.providerId);
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "Google Sign-In is not enabled in Firebase Authentication settings.";
                }
                showMessage(errorMessage, 'error');
                addLogEntry("Google Login Failed", { error: error.message });
            } finally {
                googleLoginButton.disabled = false; // Re-enable button after attempt
            }
        });

        // Placeholder for Email/Password Login
        emailPasswordLoginButton.addEventListener('click', () => {
            showMessage("Email/Password login is not yet implemented. Please use Google Sign-In.", 'info');
            addLogEntry("Email/Password Login Button Clicked", { status: "Not Implemented" });
        });


        // Event listener for logout button
        logoutButton.addEventListener('click', handleLogout);

        // --- Admin Panel Button Event Listeners ---
        manageUsersButton.addEventListener('click', () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser && loggedInUser.isAdmin) {
                showPanel(userManagementPanel);
                renderUserRolesTable();
                addLogEntry("User Management Panel Opened", { user: loggedInUser.username });
            } else {
                showMessage("You do not have administrative access to manage users.", 'error');
                addLogEntry("User Management Access Denied", { user: loggedInUser?.username || 'Unknown User' });
            }
        });

        hideUserManagementButton.addEventListener('click', () => {
            showPanel(adminPanel);
        });

        saveUserRolesButton.addEventListener('click', collectAndSaveRoles);


        // Event listeners for log viewer buttons
        viewLogsButton.addEventListener('click', () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser && loggedInUser.isAdmin) {
                showPanel(logViewer);
                populateLogFilterTypes();
                renderLogs();
                addLogEntry("View Logs Button Clicked", { user: loggedInUser.username });
            } else {
                 showMessage("You do not have administrative access to view logs.", 'error');
                 addLogEntry("View Logs Access Denied", { user: loggedInUser?.username || 'Unknown User' });
            }
        });

        hideLogsButton.addEventListener('click', () => {
            showPanel(adminPanel);
        });

        clearLogsButton.addEventListener('click', clearLogs);

        // Event listeners for log filtering and sorting
        logFilterType.addEventListener('change', renderLogs);
        logSearchText.addEventListener('input', renderLogs);
        logSortOrderRadios.forEach(radio => {
            radio.addEventListener('change', renderLogs);
        });

        // --- Account Management Button Event Listeners ---
        manageAccountButton.addEventListener('click', () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser) {
                showPanel(accountManagementPanel);
                renderAccountManagementPanel(loggedInUser);
                addLogEntry("Account Management Panel Opened", { user: loggedInUser.username });
            } else {
                showMessage("Please log in to manage your account.", 'info');
            }
        });

        hideAccountManagementButton.addEventListener('click', () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser && loggedInUser.isAdmin) {
                showPanel(adminPanel);
            } else {
                showPanel(loginButtonsContainer);
            }
        });

        linkGoogleAccountButton.addEventListener('click', handleGoogleLink);

    </script>
</body>
</html>
