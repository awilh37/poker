insert at line 2550 beta/script.js v.3.2.21


    showNotification("Submitting chip update...");
    const room = firestoreGameRooms.find(r => r.id === roomId);
    if (!room) return showNotification("Room data not found.", "error");

    // UPDATED: Target the list inside the modal
    const listEl = updateChipsModal.querySelector('#updateChipsPlayerList');
    const selects = listEl.querySelectorAll('select[data-uid]');

    const players = [];
    let totalPot = 0;
    const roomBets = room.gameState.bets || {};

    room.players.forEach(uid => {
        const playerProfile = allFirebaseUsersData.find(p => p.uid === uid);
        const bet = roomBets[uid] || 0;
        totalPot += bet;

        players.push({
            id: uid,
            bet: bet,
            chips: playerProfile?.chip_count || 0,
            status: room.gameState.status[uid] || 'pending',
            winnings: 0
        });
    });

    // Get rankings from UI
    const rankings = [];
    selects.forEach(s => {
        rankings.push({ id: s.dataset.uid, rank: parseInt(s.value, 10) });
    });

    // Simple distribution: 1st place gets all.
    // This is a placeholder for the complex v3.1 logic.
    const winners = rankings.filter(r => r.rank === 1);
    if (winners.length > 0) {
        const share = totalPot / winners.length;
        winners.forEach(winner => {
            const player = players.find(p => p.id === winner.id);
            if (player) {
                player.winnings = share;
            }
        });
    }
    // Note: This simple logic doesn't handle side pots or complex betting.

    // 7. If available_pot is not 0 (in this simple case, it always is)
    // We'll skip the error check for this placeholder.

    // 8. Update Firestore
    const batch = writeBatch(db);
    players.forEach(player => {
        // --- PATHS FIXED ---
        const playerProfileRef = doc(db, "artifacts", appId, "public", "data", "user_profiles", player.id);
        // Player's new chips = current chips - their bet + their winnings
        const newChipCount = player.chips - player.bet + player.winnings;
        batch.update(playerProfileRef, { chip_count: newChipCount });
    });

    try {
        await batch.commit();
        showNotification("Chips updated and pot distributed!", "success");
        adminRoomReset(roomId); // Reset the room for the next hand
        toggleUpdateChipsPanel(roomId, false); // Hide the panel
    } catch (error) {
        console.error("Error updating chips:", error);
        showNotification(`Error: ${error.message}`, "error");
    }