<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Chip Counts</title>
</head>
<body>
    <h1>Player Chip Counts</h1>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Chip Count</th>
            </tr>
        </thead>
        <tbody>
            <!-- Player data will be inserted here -->
        </tbody>
    </table>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBefsHEBuiRyJ31NzF885ac3ugCefzngTU",
            authDomain: "wps-3-be723.firebaseapp.com",
            projectId: "wps-3-be723",
            storageBucket: "wps-3-be723.firebasestorage.app",
            messagingSenderId: "420146617877",
            appId: "1:420146617877:web:ea2e06a690732da76fb81c",
            measurementId: "G-H0Z4C2185Y"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp, 'wps-database');

        // Firestore Collection Reference
        const userProfilesCollectionRef = collection(db, `artifacts/${appId}/public/data/user_profiles`);

        // --- Helper function to format display names ---
        function formatDisplayName(user) {
            if (!user || typeof user.displayName !== 'string' || typeof user.email !== 'string') {
                return (user && typeof user.displayName === 'string') ? user.displayName : (user && typeof user.email === 'string' ? user.email : 'N/A');
            }

            let displayName = user.displayName;
            if (user.email && typeof user.email === 'string') {
                const emailParts = user.email.split('@');
                if (emailParts.length === 2) {
                    const emailDomain = emailParts[1].toLowerCase();
                    if (emailDomain === 'wrsdk12.net') {
                        if (!displayName.endsWith(" (School)")) {
                            displayName += " (School)";
                        }
                    }
                }
            }
            return displayName;
        }

        async function fetchAndDisplayUsers() {
            const tableBody = document.querySelector("#player-table tbody");
            tableBody.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';

            try {
                const querySnapshot = await getDocs(userProfilesCollectionRef);
                const users = [];
                querySnapshot.forEach(doc => {
                    users.push(doc.data());
                });

                tableBody.innerHTML = '';

                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2">No users found.</td></tr>';
                    return;
                }

                users.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));

                users.forEach(user => {
                    const row = tableBody.insertRow();
                    const nameCell = row.insertCell();
                    const chipCell = row.insertCell();

                    nameCell.textContent = formatDisplayName(user);
                    chipCell.textContent = (typeof user.chip_count === 'number') ? user.chip_count : '0';
                });
            } catch (error) {
                console.error("Error fetching user profiles:", error);
                tableBody.innerHTML = '<tr><td colspan="2">Error loading users.</td></tr>';
            }
        }

        fetchAndDisplayUsers();
    </script>
</body>
</html>
