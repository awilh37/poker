<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPS 2.0 Login</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and overall body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Ensure padding doesn't cause overflow */
        }
        /* Style for the message box (e.g., error/success messages) */
        .message-box {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        .message-box.error {
            background-color: #fee2e2; /* Red-ish background */
            color: #ef4444; /* Red text */
            border: 1px solid #ef4444;
        }
        .message-box.success {
            background-color: #d1fae5; /* Green-ish background */
            color: #10b981; /* Green text */
            border: 1px solid #10b981;
        }
        .message-box.info {
            background-color: #bfdbfe; /* Blue-ish background */
            color: #3b82f6; /* Blue text */
            border: 1px solid #3b82f6;
        }
        /* Styling for log entries */
        .log-entry {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #4b5563;
            text-align: left;
        }
        .log-entry strong {
            color: #1f2937;
        }
        /* Table styles for user management */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .user-table th, .user-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: left;
        }
        .user-table th {
            background-color: #e0f2fe;
            color: #2563eb;
            font-weight: bold;
        }
        .user-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .user-table select {
            width: 100%;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
        }
    </style>
</head>
<body class="bg-gray-100 font-inter">

    <!-- Main Login Container -->
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm flex flex-col items-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">WPS Login</h2>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden flex items-center justify-center p-4">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600">Loading...</span>
        </div>

        <!-- Login Buttons (Email/Password fields removed) -->
        <div id="loginButtonsContainer" class="w-full flex flex-col items-center space-y-3">
            <button
                type="button"
                id="googleLoginButton"
                class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
            >
                <!-- Google Icon SVG -->
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.0001 4.5V7.5L17.2501 7.5C17.0279 8.65312 16.3989 9.69736 15.4883 10.4514C14.5776 11.2054 13.4357 11.6212 12.2501 11.6212C9.40006 11.6212 6.99999 9.40871 6.99999 6.55871C6.99999 3.70871 9.40006 1.49621 12.2501 1.49621C13.6874 1.49621 14.9754 2.05267 15.9388 2.92305L18.1565 0.705359C16.5912 -0.80332 14.4754 -1.54716e-07 12.2501 -1.54716e-07C7.26627 -1.54716e-07 3.00006 4.26627 3.00006 9.25006C3.00006 14.2338 7.26627 18.5 12.2501 18.5C14.6738 18.5 16.6346 17.6534 18.0626 16.1436C19.5398 14.6338 19.9999 12.3501 19.9999 9.94006C19.9999 9.25006 19.9312 8.57506 19.8001 7.92506L12.0001 7.92506V4.5Z" fill="#fff"/>
                </svg>
                Sign In with Google
            </button>
            <button
                type="button"
                id="emailPasswordLoginButton"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
            >
                Sign In with Email/Password (Placeholder)
            </button>
        </div>


        <!-- Message Box for Login Status -->
        <div id="messageBox" class="message-box hidden w-full"></div>

        <!-- Logout Button (Initially hidden) -->
        <button
            id="logoutButton"
            class="hidden mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
        >
            Logout
        </button>

        <!-- Admin Panel (Initially hidden) -->
        <div id="adminPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full text-center">
            <h3 class="text-2xl font-bold text-gray-700 mb-4">Admin Panel</h3>
            <p class="text-gray-600 mb-6">
                Welcome, Administrator! From here, you can manage users, game data, and other aspects of the WPS system.
                <br>
                <strong class="text-red-500">Note: User management will now only show the default admin. For full user management, a Firebase Authentication user list would be required.</strong>
            </p>
            <div class="space-y-4">
                <button id="manageUsersButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Manage Users
                </button>
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Manage Game Data
                </button>
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Configure Games
                </button>
                <button id="viewLogsButton" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    View Activity Logs
                </button>
                <button id="manageAccountButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Account Management
                </button>
            </div>
        </div>

        <!-- User Management Panel (Initially hidden) -->
        <div id="userManagementPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md">
            <h3 class="text-2xl font-bold text-gray-700 mb-4 text-center">User Management</h3>
            <p class="text-gray-600 mb-4 text-center">
                This panel currently only shows the local admin user for role assignment. For full Firebase user management, this section would need to query Firebase Authentication user list (requires server-side or Cloud Functions).
            </p>
            <div class="overflow-x-auto">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Role</th>
                        </tr>
                    </thead>
                    <tbody id="userRolesTableBody">
                        <!-- User rows will be rendered here -->
                        <tr><td colspan="3" class="text-center text-gray-500">No users to manage.</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex justify-between space-x-2 mt-4">
                <button id="saveUserRolesButton" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Save Roles (No Effect on Firebase Users)
                </button>
                <button id="hideUserManagementButton" class="w-1/2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Hide Panel
                </button>
            </div>
        </div>

        <!-- Account Management Panel (Initially hidden) -->
        <div id="accountManagementPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md text-center">
            <h3 class="text-2xl font-bold text-gray-700 mb-4">Account Management</h3>
            <div class="flex flex-col items-center space-y-4">
                <img id="userProfilePic" class="w-24 h-24 rounded-full border-4 border-blue-400 shadow-md" src="" alt="Profile Picture">
                <p class="text-xl font-semibold text-gray-800" id="currentUserName"></p>
                <p class="text-gray-600" id="currentUserUsername"></p>
                <p class="text-gray-500 text-sm" id="currentUserProvider"></p>

                <div class="w-full space-y-3 pt-4 border-t border-gray-200 mt-4">
                    <button
                        type="button"
                        id="linkGoogleAccountButton"
                        class="w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
                    >
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.0001 4.5V7.5L17.2501 7.5C17.0279 8.65312 16.3989 9.69736 15.4883 10.4514C14.5776 11.2054 13.4357 11.6212 12.2501 11.6212C9.40006 11.6212 6.99999 9.40871 6.99999 6.55871C6.99999 3.70871 9.40006 1.49621 12.2501 1.49621C13.6874 1.49621 14.9754 2.05267 15.9388 2.92305L18.1565 0.705359C16.5912 -0.80332 14.4754 -1.54716e-07 12.2501 -1.54716e-07C7.26627 -1.54716e-07 3.00006 4.26627 3.00006 9.25006C3.00006 14.2338 7.26627 18.5 12.2501 18.5C14.6738 18.5 16.6346 17.6534 18.0626 16.1436C19.5398 14.6338 19.9999 12.3501 19.9999 9.94006C19.9999 9.25006 19.9312 8.57506 19.8001 7.92506L12.0001 7.92506V4.5Z" fill="#fff"/>
                        </svg>
                        Link with Google
                    </button>
                    <button class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                        Change Password (Placeholder)
                    </button>
                    <button class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                        Update Profile (Placeholder)
                    </button>
                </div>
                <button id="hideAccountManagementButton" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Close Account Management
                </button>
            </div>
        </div>


        <!-- Activity Log Viewer (Initially hidden) -->
        <div id="logViewer" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md">
            <h3 class="text-2xl font-bold text-gray-700 mb-4 text-center">Activity Logs</h3>

            <!-- Log Filters and Sort -->
            <div class="flex flex-wrap items-center justify-between mb-4 space-y-2 md:space-y-0">
                <div class="w-full md:w-1/2 pr-0 md:pr-2">
                    <label for="logFilterType" class="block text-gray-700 text-sm font-semibold mb-1">Filter by Type:</label>
                    <select id="logFilterType" class="w-full border rounded-lg py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Types</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="w-full md:w-1/2 pl-0 md:pl-2">
                    <label for="logSearchText" class="block text-gray-700 text-sm font-semibold mb-1">Search Text:</label>
                    <input type="text" id="logSearchText" placeholder="Search logs..." class="w-full border rounded-lg py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="w-full mt-3">
                    <label class="block text-gray-700 text-sm font-semibold mb-1">Sort Order:</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="logSortOrder" value="newest" checked class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Newest First</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="logSortOrder" value="oldest" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Oldest First</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="logEntries" class="max-h-60 overflow-y-auto border border-gray-200 p-2 rounded-lg bg-white mb-4">
                <!-- Log entries will be rendered here -->
                <p class="text-gray-500 text-center">No logs yet.</p>
            </div>
            <div class="flex justify-between space-x-2">
                <button id="clearLogsButton" class="w-1/2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Clear Logs
                </button>
                <button id="hideLogsButton" class="w-1/2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Hide Logs
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, linkWithPopup } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBefsHEBuiRyJ31NzF885ac3ugCefzngTU",
            authDomain: "wps-3-be723.firebaseapp.com",
            projectId: "wps-3-be723",
            storageBucket: "wps-3-be723.firebasestorage.app",
            messagingSenderId: "420146617877",
            appId: "1:420146617877:web:ea2e06a690732da76fb81c",
            measurementId: "G-H0Z4C2185Y"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const analytics = getAnalytics(firebaseApp);
        const db = getFirestore(firebaseApp);
        const auth = getAuth(firebaseApp);
        const googleProvider = new GoogleAuthProvider();


        // Track Firebase authentication readiness
        let firebaseAuthReady = false;
        let isLoggingOut = false; // New flag to track logout state


        // --- DOM Elements ---
        // Removed usernameInput, passwordInput, loginButton
        const loginButtonsContainer = document.getElementById('loginButtonsContainer');
        const googleLoginButton = document.getElementById('googleLoginButton');
        const emailPasswordLoginButton = document.getElementById('emailPasswordLoginButton'); // Placeholder
        const messageBox = document.getElementById('messageBox');
        const logoutButton = document.getElementById('logoutButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const adminPanel = document.getElementById('adminPanel');

        // Admin panel sub-sections
        const manageUsersButton = document.getElementById('manageUsersButton');
        const userManagementPanel = document.getElementById('userManagementPanel');
        const userRolesTableBody = document.getElementById('userRolesTableBody');
        const saveUserRolesButton = document.getElementById('saveUserRolesButton');
        const hideUserManagementButton = document.getElementById('hideUserManagementButton');

        const viewLogsButton = document.getElementById('viewLogsButton');
        const logViewer = document.getElementById('logViewer');
        const logEntriesContainer = document.getElementById('logEntries');
        const clearLogsButton = document.getElementById('clearLogsButton');
        const hideLogsButton = document.getElementById('hideLogsButton');

        // Account Management elements
        const manageAccountButton = document.getElementById('manageAccountButton');
        const accountManagementPanel = document.getElementById('accountManagementPanel');
        const userProfilePic = document.getElementById('userProfilePic');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserUsername = document.getElementById('currentUserUsername');
        const currentUserProvider = document.getElementById('currentUserProvider');
        const linkGoogleAccountButton = document.getElementById('linkGoogleAccountButton');
        const hideAccountManagementButton = document.getElementById('hideAccountManagementButton');


        // Log filtering and sorting elements
        const logFilterType = document.getElementById('logFilterType');
        const logSearchText = document.getElementById('logSearchText');
        const logSortOrderRadios = document.querySelectorAll('input[name="logSortOrder"]');

        let users = []; // This will now just contain the SECRET_ADMIN_USER for management purposes
        let firestoreUserRoles = {}; // Stores roles fetched from Firestore
        let firestoreActivityLogs = []; // Stores logs fetched from Firestore

        const ROLES = ['Member', 'Moderator', 'Banned']; // Defined roles for the system

        const SECRET_ADMIN_USER = {
            username: 'admin',
            password: 'secretpassword', // Change this to your desired secret password
            name: 'Administrator',
            profilePic: 'https://placehold.co/50x50/ff0000/ffffff?text=ADM'
        };

        // Firestore Collection References
        const userRolesCollectionRef = collection(db, `artifacts/${appId}/public/data/user_roles`);
        const activityLogsCollectionRef = collection(db, `artifacts/${appId}/public/data/activity_logs`);

        // Initially disable login buttons until Firebase Auth is ready
        googleLoginButton.disabled = true;
        emailPasswordLoginButton.disabled = true;


        // --- Log System Functions (Firestore Integrated) ---
        async function addLogEntry(action, details = {}) {
            const timestamp = new Date().toISOString(); // Use ISO string for consistent sorting in Firestore
            const log = {
                timestamp: timestamp,
                action: action,
                ...details
            };
            try {
                if (auth.currentUser && auth.currentUser.uid) {
                    await addDoc(activityLogsCollectionRef, log);
                    console.log("Log added to Firestore:", log);
                } else {
                    console.warn("Firebase Auth not ready or user not authenticated. Logged locally (backup):", log);
                    const logs = JSON.parse(localStorage.getItem('activityLogsBackup') || '[]');
                    logs.push(log);
                    localStorage.setItem('activityLogsBackup', JSON.stringify(logs));
                }
            } catch (e) {
                console.error("Error saving log to Firestore:", e);
                showMessage("Error: Could not save log to cloud.", 'error');
            }
        }

        function populateLogFilterTypes() {
            const uniqueTypes = new Set(firestoreActivityLogs.map(log => log.action));
            logFilterType.innerHTML = '<option value="all">All Types</option>';
            uniqueTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                logFilterType.appendChild(option);
            });
        }

        function renderLogs() {
            logEntriesContainer.innerHTML = '';
            let logsToDisplay = [...firestoreActivityLogs];

            const selectedType = logFilterType.value;
            const searchText = logSearchText.value.toLowerCase();
            const sortOrder = document.querySelector('input[name="logSortOrder"]:checked').value;

            let filteredLogs = logsToDisplay.filter(log => {
                const matchesType = selectedType === 'all' || log.action === selectedType;
                const logContent = JSON.stringify(log).toLowerCase();
                const matchesText = logContent.includes(searchText);
                return matchesType && matchesText;
            });

            filteredLogs.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                if (sortOrder === 'newest') {
                    return dateB.getTime() - dateA.getTime();
                } else {
                    return dateA.getTime() - dateB.getTime();
                }
            });

            if (filteredLogs.length === 0) {
                logEntriesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No matching logs found.</p>';
                return;
            }

            filteredLogs.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-entry';
                let detailsHtml = '';
                for (const key in log) {
                    if (key !== 'timestamp' && key !== 'action' && key !== 'id') {
                        detailsHtml += ` <strong>${key}:</strong> ${log[key]};`;
                    }
                }
                logDiv.innerHTML = `<strong>[${new Date(log.timestamp).toLocaleString()}] ${log.action}:</strong>${detailsHtml}`;
                logEntriesContainer.appendChild(logDiv);
            });
        }

        async function clearLogs() {
             if (!confirm("Are you sure you want to clear ALL activity logs from Firestore? This cannot be undone.")) {
                return;
            }

            if (!auth.currentUser) {
                showMessage("You must be logged in to clear logs.", 'error');
                return;
            }

            showMessage("Clearing logs...", 'info');
            try {
                const querySnapshot = await getDocs(activityLogsCollectionRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                addLogEntry("Logs Cleared", { by: auth.currentUser.uid });
                showMessage('Activity logs cleared from Firestore.', 'success');
            } catch (e) {
                console.error("Error clearing logs from Firestore:", e);
                showMessage("Failed to clear logs from Firestore.", 'error');
            }
        }
        // --- End Log System Functions ---


        // --- User Management Functions (Firestore Integrated) ---
        async function saveUserRolesToFirestore(rolesMap) {
            if (!auth.currentUser) {
                showMessage("You must be logged in to save user roles.", 'error');
                return;
            }

            try {
                const oldRolesMap = firestoreUserRoles;

                for (const username in rolesMap) {
                    const newRole = rolesMap[username];
                    const docRef = doc(userRolesCollectionRef, username);

                    if (oldRolesMap[username]?.role !== newRole) {
                        await setDoc(docRef, { role: newRole }, { merge: true });
                        addLogEntry("User Role Changed", {
                            user: username,
                            oldRole: oldRolesMap[username]?.role || 'Member',
                            newRole: newRole,
                            by: auth.currentUser.email || auth.currentUser.uid
                        });
                    }
                }
                showMessage("User roles saved to Firestore.", 'success');
                setTimeout(hideMessage, 2000);
            } catch (e) {
                console.error("Error saving user roles to Firestore:", e);
                showMessage("Failed to save user roles to Firestore.", 'error');
            }
        }

        function renderUserRolesTable() {
            userRolesTableBody.innerHTML = '';
            // Only the SECRET_ADMIN_USER is manageable in this simplified setup without z.html
            const manageableUsers = [SECRET_ADMIN_USER]; // Always include the secret admin

            if (manageableUsers.length === 0) {
                userRolesTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No users to manage.</td></tr>';
                return;
            }

            manageableUsers.forEach(user => {
                const row = userRolesTableBody.insertRow();
                const userNameCell = row.insertCell();
                const userUsernameCell = row.insertCell();
                const userRoleCell = row.insertCell();

                userNameCell.textContent = user.name;
                userUsernameCell.textContent = user.username;

                const select = document.createElement('select');
                select.className = 'border rounded-lg p-1';
                select.setAttribute('data-username', user.username);

                ROLES.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    select.appendChild(option);
                });

                select.value = firestoreUserRoles[user.username]?.role || 'Member';

                userRoleCell.appendChild(select);
            });
        }

        function collectAndSaveRoles() {
            const newRolesMap = {};
            const roleSelects = userRolesTableBody.querySelectorAll('select[data-username]');

            roleSelects.forEach(select => {
                const username = select.getAttribute('data-username');
                const newRole = select.value;
                newRolesMap[username] = newRole;
            });
            saveUserRolesToFirestore(newRolesMap);
        }
        // --- End User Management Functions ---


        // --- Account Management Functions ---
        function renderAccountManagementPanel(displayUser) {
            const firebaseUser = auth.currentUser;

            userProfilePic.src = displayUser.profilePic || firebaseUser?.photoURL || 'https://placehold.co/100x100/cccccc/ffffff?text=U';
            userProfilePic.alt = `${displayUser.name || displayUser.username}'s profile picture`;
            currentUserName.textContent = displayUser.name || firebaseUser?.displayName || 'N/A';
            currentUserUsername.textContent = `Email: ${displayUser.username || firebaseUser?.email || 'N/A'}`; // Changed to Email

            let providerId = 'Unknown';
            if (firebaseUser) {
                const providers = firebaseUser.providerData.map(p => p.providerId);
                if (providers.includes('google.com')) {
                    providerId = 'Google';
                    linkGoogleAccountButton.classList.add('hidden'); // Already linked with Google
                } else if (providers.includes('password')) {
                    providerId = 'Email/Password';
                    linkGoogleAccountButton.classList.remove('hidden'); // Can link to Google
                } else if (providers.includes('anonymous')) {
                    providerId = 'Anonymous';
                    linkGoogleAccountButton.classList.remove('hidden'); // Can link to Google
                }
            } else {
                providerId = 'No Firebase Session'; // Should not happen if this panel is shown
                linkGoogleAccountButton.classList.remove('hidden');
            }
            currentUserProvider.textContent = `Provider: ${providerId}`;
        }

        async function handleGoogleLink() {
            if (!auth.currentUser) {
                showMessage("No active Firebase user session to link accounts. Please sign in first.", 'error');
                return;
            }

            showMessage("Attempting to link with Google...", 'info');
            try {
                const result = await linkWithPopup(auth.currentUser, googleProvider);
                const linkedUser = result.user;
                console.log("Account linked successfully with Google:", linkedUser);

                const updatedLoggedInUser = {
                    username: linkedUser.email || linkedUser.uid,
                    name: linkedUser.displayName || linkedUser.email,
                    profilePic: linkedUser.photoURL,
                    isAdmin: linkedUser.email === SECRET_ADMIN_USER.username,
                    firebaseUid: linkedUser.uid
                };
                localStorage.setItem('loggedInUser', JSON.stringify(updatedLoggedInUser));
                
                showMessage("Account successfully linked with Google!", 'success');
                addLogEntry("Account Linked", { user: linkedUser.email || linkedUser.uid, provider: "Google" });
                renderAccountManagementPanel(updatedLoggedInUser);
            } catch (error) {
                console.error("Error linking Google account:", error);
                let errorMessage = "Failed to link Google account.";
                if (error.code === 'auth/credential-already-in-use') {
                    errorMessage = "This Google account is already linked to another user.";
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google login window was closed.";
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid Google credential or already linked to a different account.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "The email associated with this Google account is already in use by another login method. Please sign in with that method and then link.";
                }
                showMessage(errorMessage, 'error');
                addLogEntry("Account Link Failed", { user: auth.currentUser?.uid || 'Unknown', provider: "Google", error: error.message });
            }
        }

        function showPanel(panelToShow) {
            const panels = [loginButtonsContainer, adminPanel, userManagementPanel, logViewer, accountManagementPanel];
            panels.forEach(panel => {
                if (panel === panelToShow) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
        }

        // Function to display messages to the user
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type} w-full`;
            messageBox.classList.remove('hidden');
        }

        // Function to hide messages
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        // Function to handle successful login
        function handleLoginSuccess(userObjectToDisplay) {
            const firebaseUser = auth.currentUser;
            const finalUserForLocalStorage = {
                username: firebaseUser?.email || userObjectToDisplay.username || firebaseUser?.uid,
                name: firebaseUser?.displayName || userObjectToDisplay.name,
                profilePic: firebaseUser?.photoURL || userObjectToDisplay.profilePic,
                isAdmin: userObjectToDisplay.username === SECRET_ADMIN_USER.username,
                firebaseUid: firebaseUser?.uid
            };

            localStorage.setItem('loggedInUser', JSON.stringify(finalUserForLocalStorage));

            showMessage(`Welcome, ${finalUserForLocalStorage.name}!`, 'success');
            
            if (finalUserForLocalStorage.isAdmin) {
                showPanel(adminPanel);
                addLogEntry("Admin Login", { user: finalUserForLocalStorage.username });
            } else {
                showPanel(accountManagementPanel);
                renderAccountManagementPanel(finalUserForLocalStorage);
                addLogEntry("User Login", { user: finalUserForLocalStorage.username });
            }
            logoutButton.classList.remove('hidden');
        }

        // Function to handle logout
        async function handleLogout() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                addLogEntry("Logout", { user: user.username, isAdmin: user.isAdmin });
            } else {
                 addLogEntry("Logout", { user: "Unknown" });
            }

            isLoggingOut = true; 
            try {
                if (auth.currentUser) {
                    await auth.signOut();
                    console.log("Firebase: Signed out.");
                }
            } catch (error) {
                console.error("Firebase: Error signing out:", error);
            }

            localStorage.removeItem('loggedInUser');
            showMessage('You have been logged out.', 'info');
            showPanel(loginButtonsContainer); // Show login buttons directly
            logoutButton.classList.add('hidden');
            // No need to clear username/password inputs as they are removed
        }

        // --- Initial Data Loading (Simplified since z.html is removed) ---
        async function loadInitialData() {
            loadingIndicator.classList.remove('hidden');
            try {
                // Since z.html is removed, 'users' array will only contain SECRET_ADMIN_USER
                users = [SECRET_ADMIN_USER]; // Initialize users array with just the admin
                showMessage("System ready. Please sign in with Google.", 'info');
                addLogEntry("Application Initialized");

            } catch (error) {
                console.error("Failed to initialize local data:", error);
                showMessage(`Failed to load initial data: ${error.message}.`, 'error');
                addLogEntry("Initial data load failed", { error: error.message });
            } finally {
                loadingIndicator.classList.add('hidden');
                // Re-enable login buttons here after initial data (even minimal) is ready
                googleLoginButton.disabled = false;
                emailPasswordLoginButton.disabled = false; // Still disabled but enable the button
            }
        }

        // --- Firestore Real-time Listeners ---
        function setupFirestoreListeners() {
            onSnapshot(userRolesCollectionRef, (snapshot) => {
                const newRoles = {};
                snapshot.forEach(doc => {
                    newRoles[doc.id] = doc.data();
                });
                firestoreUserRoles = newRoles;
                console.log("Firestore: User Roles updated:", firestoreUserRoles);
                if (!userManagementPanel.classList.contains('hidden')) {
                    renderUserRolesTable();
                }
            }, (error) => {
                console.error("Firestore: Error listening to user roles:", error);
                showMessage("Error: Could not sync user roles from cloud.", 'error');
            });

            onSnapshot(activityLogsCollectionRef, (snapshot) => {
                const newLogs = [];
                snapshot.forEach(doc => {
                    newLogs.push({ id: doc.id, ...doc.data() });
                });
                firestoreActivityLogs = newLogs;
                console.log("Firestore: Activity Logs updated:", firestoreActivityLogs.length, "entries");
                populateLogFilterTypes();
                renderLogs();
            }, (error) => {
                console.error("Firestore: Error listening to activity logs:", error);
                showMessage("Error: Could not sync activity logs from cloud.", 'error');
            });
        }


        // Initialize all logic after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired. Script is running.');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is authenticated (from Google, Email/Password, or custom token from Canvas)
                    console.log("Firebase: Authenticated. User ID:", user.uid, "Provider:", user.providerData[0]?.providerId || 'N/A');
                    firebaseAuthReady = true;
                    // Ensure buttons are enabled after auth state is confirmed
                    googleLoginButton.disabled = false;
                    emailPasswordLoginButton.disabled = false;

                    await loadInitialData(); // Load minimal local data (just admin)
                    setupFirestoreListeners(); // Setup Firestore listeners

                    // Check for a saved login state in localStorage
                    const storedUser = localStorage.getItem('loggedInUser');
                    if (storedUser) {
                        try {
                            const loggedInUser = JSON.parse(storedUser);
                            handleLoginSuccess(loggedInUser);
                        } catch (e) {
                            console.error("Error parsing stored user data from localStorage:", e);
                            localStorage.removeItem('loggedInUser');
                            showMessage("Saved login data corrupted. Please log in again.", 'error');
                            addLogEntry("Corrupted saved login detected (localStorage)");
                        }
                    } else {
                        // If Firebase Auth has a user but localStorage doesn't, create a display user from Firebase data
                        const displayUser = {
                            username: user.email || user.uid,
                            name: user.displayName || user.email || 'Anonymous User',
                            profilePic: user.photoURL || 'https://placehold.co/50x50/cccccc/ffffff?text=U',
                            isAdmin: user.email === SECRET_ADMIN_USER.username
                        };
                        handleLoginSuccess(displayUser);
                    }

                } else { // No Firebase user is currently authenticated
                    if (initialAuthToken) {
                        // In Canvas environment, sign in with custom token provided
                        console.log("Firebase: Canvas environment detected. Signing in with custom token.");
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Firebase: Custom authentication failed:", error);
                            showMessage(`Firebase custom auth failed: ${error.message}. Firestore features may not work.`, 'error');
                        } finally {
                            firebaseAuthReady = true;
                            googleLoginButton.disabled = false;
                            emailPasswordLoginButton.disabled = false;
                            await loadInitialData();
                            setupFirestoreListeners();
                        }
                    } else if (!isLoggingOut) {
                        // For regular web deployment, show login buttons and don't auto-authenticate
                        console.log("Firebase: Not authenticated. Displaying login options.");
                        firebaseAuthReady = true;
                        googleLoginButton.disabled = false;
                        emailPasswordLoginButton.disabled = false;
                        showPanel(loginButtonsContainer);
                        logoutButton.classList.add('hidden');
                        await loadInitialData();
                        setupFirestoreListeners();
                    } else {
                        // User explicitly logged out, keep displaying login form
                        console.log("Firebase: User logged out manually. Not re-authenticating.");
                        firebaseAuthReady = true;
                        googleLoginButton.disabled = false;
                        emailPasswordLoginButton.disabled = false;
                        showPanel(loginButtonsContainer);
                        logoutButton.classList.add('hidden');
                        isLoggingOut = false;
                    }
                }
            });
        });


        // Removed event listener for loginForm.submit as it no longer exists

        // Event listener for Google Login Button (primary login method)
        googleLoginButton.addEventListener('click', async () => {
            console.log('Google Login button clicked.');
            addLogEntry("Google Login Attempt");

            if (!firebaseAuthReady) {
                showMessage("Firebase authentication is not ready yet. Please wait a moment and try again.", 'info');
                return;
            }
            
            try {
                // If an anonymous user exists from previous session (unlikely with new flow, but safe to handle)
                // or if no user, signInWithPopup will handle it.
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                console.log("Google Sign-In successful:", user);

                // Use Firebase user info directly for display and storage
                let displayUser = {
                    username: user.email,
                    name: user.displayName,
                    profilePic: user.photoURL
                };
                handleLoginSuccess(displayUser);
                addLogEntry("Google Login Success", { user: user.email || user.uid });

            } catch (error) {
                console.error("Google Sign-In failed:", error);
                let errorMessage = "Google sign-in failed.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google login window was closed.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Popup blocked or already open.";
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                     errorMessage = `An account already exists with this email using a different login method.`;
                     console.warn(errorMessage, "Provider ID:", error.customData.email, error.credential.providerId);
                }
                showMessage(errorMessage, 'error');
                addLogEntry("Google Login Failed", { error: error.message });
            }
        });

        // Placeholder for Email/Password Login
        emailPasswordLoginButton.addEventListener('click', () => {
            showMessage("Email/Password login is not yet implemented. Please use Google Sign-In.", 'info');
            addLogEntry("Email/Password Login Button Clicked", { status: "Not Implemented" });
        });


        // Event listener for logout button
        logoutButton.addEventListener('click', handleLogout);

        // --- Admin Panel Button Event Listeners ---
        manageUsersButton.addEventListener('click', () => {
            showPanel(userManagementPanel);
            renderUserRolesTable();
            addLogEntry("User Management Panel Opened", { user: SECRET_ADMIN_USER.username });
        });

        hideUserManagementButton.addEventListener('click', () => {
            showPanel(adminPanel);
        });

        saveUserRolesButton.addEventListener('click', collectAndSaveRoles);


        // Event listeners for log viewer buttons
        viewLogsButton.addEventListener('click', () => {
            showPanel(logViewer);
            populateLogFilterTypes();
            renderLogs();
            addLogEntry("View Logs Button Clicked", { user: localStorage.getItem('loggedInUser') ? JSON.parse(localStorage.getItem('loggedInUser')).username : 'Unknown' });
        });

        hideLogsButton.addEventListener('click', () => {
            showPanel(adminPanel);
        });

        clearLogsButton.addEventListener('click', clearLogs);

        // Event listeners for log filtering and sorting
        logFilterType.addEventListener('change', renderLogs);
        logSearchText.addEventListener('input', renderLogs);
        logSortOrderRadios.forEach(radio => {
            radio.addEventListener('change', renderLogs);
        });

        // --- Account Management Button Event Listeners ---
        manageAccountButton.addEventListener('click', () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser) {
                showPanel(accountManagementPanel);
                renderAccountManagementPanel(loggedInUser);
                addLogEntry("Account Management Panel Opened", { user: loggedInUser.username });
            } else {
                showMessage("Please log in to manage your account.", 'info');
            }
        });

        hideAccountManagementButton.addEventListener('click', () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser && loggedInUser.isAdmin) {
                showPanel(adminPanel);
            } else {
                showPanel(loginButtonsContainer); // Go back to login options
            }
        });

        linkGoogleAccountButton.addEventListener('click', handleGoogleLink);

    </script>
</body>
</html>
