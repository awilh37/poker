<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPS 2.0 Login</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and overall body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Ensure padding doesn't cause overflow */
        }
        /* Style for the message box (e.g., error/success messages) */
        .message-box {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        .message-box.error {
            background-color: #fee2e2; /* Red-ish background */
            color: #ef4444; /* Red text */
            border: 1px solid #ef4444;
        }
        .message-box.success {
            background-color: #d1fae5; /* Green-ish background */
            color: #10b981; /* Green text */
            border: 1px solid #10b981;
        }
        .message-box.info {
            background-color: #bfdbfe; /* Blue-ish background */
            color: #3b82f6; /* Blue text */
            border: 1px solid #3b82f6;
        }
        /* Styling for log entries */
        .log-entry {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #4b5563;
            text-align: left;
        }
        .log-entry strong {
            color: #1f2937;
        }
        /* Table styles for user management */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .user-table th, .user-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: left;
        }
        .user-table th {
            background-color: #e0f2fe;
            color: #2563eb;
            font-weight: bold;
        }
        .user-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .user-table select {
            width: 100%;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
        }
    </style>
</head>
<body class="bg-gray-100 font-inter">

    <!-- Main Login Container -->
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm flex flex-col items-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">WPS Login</h2>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden flex items-center justify-center p-4">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600">Loading user data...</span>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="w-full">
            <div class="mb-4">
                <label for="username" class="block text-gray-700 text-sm font-semibold mb-2">Username</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out"
                    placeholder="Enter your username"
                    required
                >
            </div>
            <div class="mb-6">
                <label for="password">Password</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out"
                    placeholder="Enter your password"
                    required
                >
            </div>
            <button
                type="submit"
                id="loginButton"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
            >
                Log In
            </button>
            <button
                type="button"
                id="googleLoginButton"
                class="w-full mt-3 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
            >
                <!-- Google Icon SVG (example, you might use a proper library or image) -->
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.0001 4.5V7.5L17.2501 7.5C17.0279 8.65312 16.3989 9.69736 15.4883 10.4514C14.5776 11.2054 13.4357 11.6212 12.2501 11.6212C9.40006 11.6212 6.99999 9.40871 6.99999 6.55871C6.99999 3.70871 9.40006 1.49621 12.2501 1.49621C13.6874 1.49621 14.9754 2.05267 15.9388 2.92305L18.1565 0.705359C16.5912 -0.80332 14.4754 -1.54716e-07 12.2501 -1.54716e-07C7.26627 -1.54716e-07 3.00006 4.26627 3.00006 9.25006C3.00006 14.2338 7.26627 18.5 12.2501 18.5C14.6738 18.5 16.6346 17.6534 18.0626 16.1436C19.5398 14.6338 19.9999 12.3501 19.9999 9.94006C19.9999 9.25006 19.9312 8.57506 19.8001 7.92506L12.0001 7.92506V4.5Z" fill="#fff"/>
                </svg>
                Sign In with Google
            </button>
        </form>

        <!-- Message Box for Login Status -->
        <div id="messageBox" class="message-box hidden w-full"></div>

        <!-- Logout Button (Initially hidden) -->
        <button
            id="logoutButton"
            class="hidden mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
        >
            Logout
        </button>

        <!-- Admin Panel (Initially hidden) -->
        <div id="adminPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full text-center">
            <h3 class="text-2xl font-bold text-gray-700 mb-4">Admin Panel</h3>
            <p class="text-gray-600 mb-6">
                Welcome, Administrator! From here, you can manage users, game data, and other aspects of the WPS system.
                <br>
                <strong class="text-red-500">Note: Data is now stored in Firestore.</strong>
            </p>
            <div class="space-y-4">
                <button id="manageUsersButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Manage Users
                </button>
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Manage Game Data
                </button>
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Configure Games
                </button>
                <button id="viewLogsButton" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    View Activity Logs
                </button>
                <button id="manageAccountButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Account Management
                </button>
            </div>
        </div>

        <!-- User Management Panel (Initially hidden) -->
        <div id="userManagementPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md">
            <h3 class="text-2xl font-bold text-gray-700 mb-4 text-center">User Management</h3>
            <p class="text-gray-600 mb-4 text-center">
                Assign roles to users. Changes are saved to Firestore.
            </p>
            <div class="overflow-x-auto">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Role</th>
                        </tr>
                    </thead>
                    <tbody id="userRolesTableBody">
                        <!-- User rows will be rendered here -->
                        <tr><td colspan="3" class="text-center text-gray-500">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex justify-between space-x-2 mt-4">
                <button id="saveUserRolesButton" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Save Roles
                </button>
                <button id="hideUserManagementButton" class="w-1/2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Hide Panel
                </button>
            </div>
        </div>

        <!-- Account Management Panel (Initially hidden) -->
        <div id="accountManagementPanel" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md text-center">
            <h3 class="text-2xl font-bold text-gray-700 mb-4">Account Management</h3>
            <div class="flex flex-col items-center space-y-4">
                <img id="userProfilePic" class="w-24 h-24 rounded-full border-4 border-blue-400 shadow-md" src="" alt="Profile Picture">
                <p class="text-xl font-semibold text-gray-800" id="currentUserName"></p>
                <p class="text-gray-600" id="currentUserUsername"></p>
                <p class="text-gray-500 text-sm" id="currentUserProvider"></p>

                <div class="w-full space-y-3 pt-4 border-t border-gray-200 mt-4">
                    <button
                        type="button"
                        id="linkGoogleAccountButton"
                        class="w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105"
                    >
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.0001 4.5V7.5L17.2501 7.5C17.0279 8.65312 16.3989 9.69736 15.4883 10.4514C14.5776 11.2054 13.4357 11.6212 12.2501 11.6212C9.40006 11.6212 6.99999 9.40871 6.99999 6.55871C6.99999 3.70871 9.40006 1.49621 12.2501 1.49621C13.6874 1.49621 14.9754 2.05267 15.9388 2.92305L18.1565 0.705359C16.5912 -0.80332 14.4754 -1.54716e-07 12.2501 -1.54716e-07C7.26627 -1.54716e-07 3.00006 4.26627 3.00006 9.25006C3.00006 14.2338 7.26627 18.5 12.2501 18.5C14.6738 18.5 16.6346 17.6534 18.0626 16.1436C19.5398 14.6338 19.9999 12.3501 19.9999 9.94006C19.9999 9.25006 19.9312 8.57506 19.8001 7.92506L12.0001 7.92506V4.5Z" fill="#fff"/>
                        </svg>
                        Link with Google
                    </button>
                    <button class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                        Change Password (Placeholder)
                    </button>
                    <button class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                        Update Profile (Placeholder)
                    </button>
                </div>
                <button id="hideAccountManagementButton" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Close Account Management
                </button>
            </div>
        </div>


        <!-- Activity Log Viewer (Initially hidden) -->
        <div id="logViewer" class="hidden mt-8 p-6 bg-gray-50 rounded-xl shadow-inner w-full max-w-md">
            <h3 class="text-2xl font-bold text-gray-700 mb-4 text-center">Activity Logs</h3>

            <!-- Log Filters and Sort -->
            <div class="flex flex-wrap items-center justify-between mb-4 space-y-2 md:space-y-0">
                <div class="w-full md:w-1/2 pr-0 md:pr-2">
                    <label for="logFilterType" class="block text-gray-700 text-sm font-semibold mb-1">Filter by Type:</label>
                    <select id="logFilterType" class="w-full border rounded-lg py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Types</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="w-full md:w-1/2 pl-0 md:pl-2">
                    <label for="logSearchText" class="block text-gray-700 text-sm font-semibold mb-1">Search Text:</label>
                    <input type="text" id="logSearchText" placeholder="Search logs..." class="w-full border rounded-lg py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="w-full mt-3">
                    <label class="block text-gray-700 text-sm font-semibold mb-1">Sort Order:</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="logSortOrder" value="newest" checked class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Newest First</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="logSortOrder" value="oldest" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Oldest First</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="logEntries" class="max-h-60 overflow-y-auto border border-gray-200 p-2 rounded-lg bg-white mb-4">
                <!-- Log entries will be rendered here -->
                <p class="text-gray-500 text-center">No logs yet.</p>
            </div>
            <div class="flex justify-between space-x-2">
                <button id="clearLogsButton" class="w-1/2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Clear Logs
                </button>
                <button id="hideLogsButton" class="w-1/2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    Hide Logs
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, linkWithPopup } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBefsHEBuiRyJ31NzF885ac3ugCefzngTU",
            authDomain: "wps-3-be723.firebaseapp.com",
            projectId: "wps-3-be723",
            storageBucket: "wps-3-be723.firebasestorage.app",
            messagingSenderId: "420146617877",
            appId: "1:420146617877:web:ea2e06a690732da76fb81c",
            measurementId: "G-H0Z4C2185Y"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const analytics = getAnalytics(firebaseApp);
        const db = getFirestore(firebaseApp);
        const auth = getAuth(firebaseApp);
        const googleProvider = new GoogleAuthProvider();


        // Track Firebase authentication readiness
        let firebaseAuthReady = false;
        let isLoggingOut = false; // New flag to track logout state


        // --- DOM Elements ---
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const googleLoginButton = document.getElementById('googleLoginButton');
        const messageBox = document.getElementById('messageBox');
        const logoutButton = document.getElementById('logoutButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const adminPanel = document.getElementById('adminPanel');

        // Admin panel sub-sections
        const manageUsersButton = document.getElementById('manageUsersButton');
        const userManagementPanel = document.getElementById('userManagementPanel');
        const userRolesTableBody = document.getElementById('userRolesTableBody');
        const saveUserRolesButton = document.getElementById('saveUserRolesButton');
        const hideUserManagementButton = document.getElementById('hideUserManagementButton');

        const viewLogsButton = document.getElementById('viewLogsButton');
        const logViewer = document.getElementById('logViewer');
        const logEntriesContainer = document.getElementById('logEntries');
        const clearLogsButton = document.getElementById('clearLogsButton');
        const hideLogsButton = document.getElementById('hideLogsButton');

        // Account Management elements
        const manageAccountButton = document.getElementById('manageAccountButton');
        const accountManagementPanel = document.getElementById('accountManagementPanel');
        const userProfilePic = document.getElementById('userProfilePic');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserUsername = document.getElementById('currentUserUsername');
        const currentUserProvider = document.getElementById('currentUserProvider');
        const linkGoogleAccountButton = document.getElementById('linkGoogleAccountButton');
        const hideAccountManagementButton = document.getElementById('hideAccountManagementButton');


        // Log filtering and sorting elements
        const logFilterType = document.getElementById('logFilterType');
        const logSearchText = document.getElementById('logSearchText');
        const logSortOrderRadios = document.querySelectorAll('input[name="logSortOrder"]');

        let users = []; // All fetched users from z.html (used for initial login)
        let firestoreUserRoles = {}; // Stores roles fetched from Firestore
        let firestoreActivityLogs = []; // Stores logs fetched from Firestore

        const ROLES = ['Member', 'Moderator', 'Banned']; // Defined roles for the system

        const SECRET_ADMIN_USER = {
            username: 'admin',
            password: 'secretpassword', // Change this to your desired secret password
            name: 'Administrator',
            profilePic: 'https://placehold.co/50x50/ff0000/ffffff?text=ADM'
        };

        // Firestore Collection References
        const userRolesCollectionRef = collection(db, `artifacts/${appId}/public/data/user_roles`);
        const activityLogsCollectionRef = collection(db, `artifacts/${appId}/public/data/activity_logs`);


        // --- Log System Functions (Firestore Integrated) ---
        async function addLogEntry(action, details = {}) {
            const timestamp = new Date().toISOString(); // Use ISO string for consistent sorting in Firestore
            const log = {
                timestamp: timestamp,
                action: action,
                ...details
            };
            try {
                // Ensure auth.currentUser exists before attempting to log to Firestore
                // If it doesn't exist, it means Firebase Auth hasn't completed or failed.
                // In such cases, we log to localStorage as a backup.
                if (auth.currentUser && auth.currentUser.uid) {
                    await addDoc(activityLogsCollectionRef, log);
                    console.log("Log added to Firestore:", log);
                } else {
                    console.warn("Firebase Auth not ready or user not authenticated. Logged locally (backup):", log);
                    const logs = JSON.parse(localStorage.getItem('activityLogsBackup') || '[]');
                    logs.push(log);
                    localStorage.setItem('activityLogsBackup', JSON.stringify(logs));
                }
            } catch (e) {
                console.error("Error saving log to Firestore:", e);
                showMessage("Error: Could not save log to cloud.", 'error');
            }
            // renderLogs is handled by the onSnapshot listener for activityLogsCollectionRef
        }

        function populateLogFilterTypes() {
            const uniqueTypes = new Set(firestoreActivityLogs.map(log => log.action));
            logFilterType.innerHTML = '<option value="all">All Types</option>';
            uniqueTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                logFilterType.appendChild(option);
            });
        }

        function renderLogs() {
            logEntriesContainer.innerHTML = '';
            let logsToDisplay = [...firestoreActivityLogs]; // Use a copy of the live data

            // Apply Filters
            const selectedType = logFilterType.value;
            const searchText = logSearchText.value.toLowerCase();
            const sortOrder = document.querySelector('input[name="logSortOrder"]:checked').value;

            let filteredLogs = logsToDisplay.filter(log => {
                const matchesType = selectedType === 'all' || log.action === selectedType;
                const logContent = JSON.stringify(log).toLowerCase();
                const matchesText = logContent.includes(searchText);
                return matchesType && matchesText;
            });

            // Apply Sorting (using timestamp from Firestore)
            filteredLogs.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                if (sortOrder === 'newest') {
                    return dateB.getTime() - dateA.getTime();
                } else {
                    return dateA.getTime() - dateB.getTime();
                }
            });

            if (filteredLogs.length === 0) {
                logEntriesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No matching logs found.</p>';
                return;
            }

            filteredLogs.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-entry';
                let detailsHtml = '';
                for (const key in log) {
                    if (key !== 'timestamp' && key !== 'action' && key !== 'id') { // 'id' is Firestore doc ID
                        detailsHtml += ` <strong>${key}:</strong> ${log[key]};`;
                    }
                }
                logDiv.innerHTML = `<strong>[${new Date(log.timestamp).toLocaleString()}] ${log.action}:</strong>${detailsHtml}`;
                logEntriesContainer.appendChild(logDiv);
            });
        }

        async function clearLogs() {
             if (!confirm("Are you sure you want to clear ALL activity logs from Firestore? This cannot be undone.")) {
                return;
            }

            if (!auth.currentUser) {
                showMessage("You must be logged in to clear logs.", 'error');
                return;
            }

            showMessage("Clearing logs...", 'info');
            try {
                const querySnapshot = await getDocs(activityLogsCollectionRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                addLogEntry("Logs Cleared", { by: auth.currentUser.uid });
                showMessage('Activity logs cleared from Firestore.', 'success');
            } catch (e) {
                console.error("Error clearing logs from Firestore:", e);
                showMessage("Failed to clear logs from Firestore.", 'error');
            }
        }
        // --- End Log System Functions ---


        // --- User Management Functions (Firestore Integrated) ---
        async function saveUserRolesToFirestore(rolesMap) {
            if (!auth.currentUser) {
                showMessage("You must be logged in to save user roles.", 'error');
                return;
            }

            try {
                // Get the current roles from Firestore to determine what changed
                const oldRolesMap = firestoreUserRoles;

                for (const username in rolesMap) {
                    const newRole = rolesMap[username];
                    const docRef = doc(userRolesCollectionRef, username); // Use username as document ID

                    if (oldRolesMap[username]?.role !== newRole) { // Check if role actually changed
                        await setDoc(docRef, { role: newRole }, { merge: true }); // Use merge to only update role
                        addLogEntry("User Role Changed", {
                            user: username,
                            oldRole: oldRolesMap[username]?.role || 'Member',
                            newRole: newRole,
                            by: auth.currentUser.email || auth.currentUser.uid
                        });
                    }
                }
                showMessage("User roles saved to Firestore.", 'success');
                setTimeout(hideMessage, 2000);
            } catch (e) {
                console.error("Error saving user roles to Firestore:", e);
                showMessage("Failed to save user roles to Firestore.", 'error');
            }
        }

        function renderUserRolesTable() {
            userRolesTableBody.innerHTML = '';
            // Filter out the SECRET_ADMIN_USER from the list to manage, as their role is implicit
            const manageableUsers = users.filter(user => user.username !== SECRET_ADMIN_USER.username);

            if (manageableUsers.length === 0) {
                userRolesTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No users to manage.</td></tr>';
                return;
            }

            manageableUsers.forEach(user => {
                const row = userRolesTableBody.insertRow();
                const userNameCell = row.insertCell();
                const userUsernameCell = row.insertCell();
                const userRoleCell = row.insertCell();

                userNameCell.textContent = user.name;
                userUsernameCell.textContent = user.username;

                const select = document.createElement('select');
                select.className = 'border rounded-lg p-1';
                select.setAttribute('data-username', user.username);

                ROLES.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    select.appendChild(option);
                });

                // Set the current selected role, defaulting to 'Member' if not found in Firestore
                select.value = firestoreUserRoles[user.username]?.role || 'Member';

                userRoleCell.appendChild(select);
            });
        }

        function collectAndSaveRoles() {
            const newRolesMap = {};
            const roleSelects = userRolesTableBody.querySelectorAll('select[data-username]');

            roleSelects.forEach(select => {
                const username = select.getAttribute('data-username');
                const newRole = select.value;
                newRolesMap[username] = newRole;
            });
            saveUserRolesToFirestore(newRolesMap);
        }
        // --- End User Management Functions ---


        // --- Account Management Functions ---
        function renderAccountManagementPanel(displayUser) {
            const firebaseUser = auth.currentUser;

            userProfilePic.src = displayUser.profilePic || firebaseUser?.photoURL || 'https://placehold.co/100x100/cccccc/ffffff?text=U';
            userProfilePic.alt = `${displayUser.name || displayUser.username}'s profile picture`;
            currentUserName.textContent = displayUser.name || firebaseUser?.displayName || 'N/A';
            currentUserUsername.textContent = `Username: ${displayUser.username || firebaseUser?.email || firebaseUser?.uid}`;

            let providerId = 'Unknown';
            if (firebaseUser) {
                const providers = firebaseUser.providerData.map(p => p.providerId);
                if (providers.includes('google.com')) {
                    providerId = 'Google';
                    linkGoogleAccountButton.classList.add('hidden'); // Already linked with Google
                } else if (providers.includes('password') || providers.includes('anonymous')) {
                    // Show link button if it's email/password or anonymous (or z.html-based)
                    providerId = providers.includes('password') ? 'Email/Password' : 'Anonymous';
                    linkGoogleAccountButton.classList.remove('hidden');
                } else {
                    linkGoogleAccountButton.classList.remove('hidden'); // Default to showing link if unsure
                }
            } else {
                // This case should ideally not happen if a user is "logged in" via handleLoginSuccess
                // but if it does, it's a local z.html only login without Firebase session
                providerId = 'Local (z.html - No Firebase)';
                linkGoogleAccountButton.classList.remove('hidden'); // Allow linking for this case
            }
            currentUserProvider.textContent = `Provider: ${providerId}`;
        }

        async function handleGoogleLink() {
            // Ensure there's a current Firebase Auth user (could be anonymous)
            if (!auth.currentUser) {
                showMessage("No active Firebase user session to link accounts. Please try logging in again.", 'error');
                return;
            }

            showMessage("Attempting to link with Google...", 'info');
            try {
                const result = await linkWithPopup(auth.currentUser, googleProvider);
                const linkedUser = result.user;
                console.log("Account linked successfully with Google:", linkedUser);

                // Update localStorage with new provider info and re-render
                // It's important to update the localStorage 'loggedInUser' with the Firebase Auth details
                // for consistent display across sessions, especially if they were previously z.html only.
                const updatedLoggedInUser = {
                    username: linkedUser.email || linkedUser.uid,
                    name: linkedUser.displayName || linkedUser.email,
                    profilePic: linkedUser.photoURL,
                    isAdmin: linkedUser.email === SECRET_ADMIN_USER.username // Re-evaluate admin status
                };
                localStorage.setItem('loggedInUser', JSON.stringify(updatedLoggedInUser));
                
                showMessage("Account successfully linked with Google!", 'success');
                addLogEntry("Account Linked", { user: linkedUser.email || linkedUser.uid, provider: "Google" });
                renderAccountManagementPanel(updatedLoggedInUser); // Re-render with new data
            } catch (error) {
                console.error("Error linking Google account:", error);
                let errorMessage = "Failed to link Google account.";
                if (error.code === 'auth/credential-already-in-use') {
                    errorMessage = "This Google account is already linked to another user.";
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google login window was closed.";
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid Google credential or already linked to a different account.";
                }
                showMessage(errorMessage, 'error');
                addLogEntry("Account Link Failed", { user: auth.currentUser?.uid || 'Unknown', provider: "Google", error: error.message });
            }
        }

        function showPanel(panelToShow) {
            const panels = [loginForm, adminPanel, userManagementPanel, logViewer, accountManagementPanel];
            panels.forEach(panel => {
                if (panel === panelToShow) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
        }

        // Function to display messages to the user
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type} w-full`; // Reset classes and apply new ones
            messageBox.classList.remove('hidden');
        }

        // Function to hide messages
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        // Function to handle successful login
        // This function now centralizes UI updates and localStorage based on the *conceptual* user
        // which might be an z.html local user mapped to a Firebase anonymous UID.
        function handleLoginSuccess(userObjectToDisplay) { // Renamed parameter for clarity
            // Use current Firebase user if available, otherwise fallback to z.html data for display
            const firebaseUser = auth.currentUser;
            const finalUserForLocalStorage = {
                username: firebaseUser?.email || userObjectToDisplay.username || firebaseUser?.uid,
                name: firebaseUser?.displayName || userObjectToDisplay.name,
                profilePic: firebaseUser?.photoURL || userObjectToDisplay.profilePic,
                isAdmin: userObjectToDisplay.username === SECRET_ADMIN_USER.username, // Admin check remains for secret
                firebaseUid: firebaseUser?.uid // Store Firebase UID for consistent tracking
            };

            localStorage.setItem('loggedInUser', JSON.stringify(finalUserForLocalStorage));

            showMessage(`Welcome, ${finalUserForLocalStorage.name}!`, 'success');
            
            if (finalUserForLocalStorage.isAdmin) {
                showPanel(adminPanel); // Show admin panel for admin
                addLogEntry("Admin Login", { user: finalUserForLocalStorage.username });
            } else {
                showPanel(accountManagementPanel); // Show account management for regular users
                renderAccountManagementPanel(finalUserForLocalStorage); // Populate account management details
                addLogEntry("User Login", { user: finalUserForLocalStorage.username });
            }
            logoutButton.classList.remove('hidden');
        }

        // Function to handle logout
        async function handleLogout() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                addLogEntry("Logout", { user: user.username, isAdmin: user.isAdmin });
            } else {
                 addLogEntry("Logout", { user: "Unknown" });
            }

            // Set the flag to true before signing out
            isLoggingOut = true; 
            try {
                if (auth.currentUser) {
                    await auth.signOut(); // Sign out from Firebase Auth
                    console.log("Firebase: Signed out.");
                }
            } catch (error) {
                console.error("Firebase: Error signing out:", error);
            }

            localStorage.removeItem('loggedInUser');
            showMessage('You have been logged out.', 'info');
            showPanel(loginForm); // Go back to login form
            logoutButton.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // Function to parse the user data from the fetched HTML table
        function parseUserData(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const table = doc.querySelector('table');

            if (!table) {
                console.error("No table found in z.html content.");
                showMessage("Error: User data table not found in z.html.", 'error');
                return [];
            }

            const rows = table.querySelectorAll('tr');
            if (rows.length < 4) { // Need at least 4 rows for username, password, name, profile pic
                console.error("Not enough rows in z.html table for user data (expected at least 4).");
                showMessage("Error: z.html table structure is unexpected.", 'error');
                return [];
            }

            const usersData = [];
            const usernames = Array.from(rows[0].querySelectorAll('th, td')).map(cell => cell.textContent.trim());
            const passwords = Array.from(rows[1].querySelectorAll('td')).map(cell => cell.textContent.trim());
            const names = Array.from(rows[2].querySelectorAll('td')).map(cell => cell.textContent.trim());
            const profilePics = Array.from(rows[3].querySelectorAll('td')).map(cell => cell.textContent.trim());

            // Transpose the data: iterate through columns to create user objects
            for (let i = 0; i < usernames.length; i++) {
                const userObj = {
                    username: usernames[i] || '',
                    password: passwords[i] || '', // SECURITY WARNING: Plain text password
                    name: names[i] || '',
                    profilePic: profilePics[i] || 'https://placehold.co/50x50/cccccc/ffffff?text=?' // Placeholder for missing pic
                };
                usersData.push(userObj);
            }
            return usersData;
        }

        // Function to fetch initial user data (from z.html)
        async function fetchInitialUserData() {
            loadingIndicator.classList.remove('hidden');
            loginButton.disabled = true;
            googleLoginButton.disabled = true;
            try {
                addLogEntry("Attempting to fetch initial user data from z.html");
                const response = await fetch('https://awilh37.github.io/data/z.html');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const htmlContent = await response.text();
                users = parseUserData(htmlContent);

                // Add the secret admin user to the list for client-side login validation
                users.push(SECRET_ADMIN_USER);

                if (users.length === 1) {
                    showMessage("No user data loaded from z.html (only secret admin available). Login will work for admin.", 'info');
                    addLogEntry("Initial user data loaded", { status: "z.html empty, admin only" });
                } else {
                    showMessage("Initial user data loaded successfully!", 'info');
                    setTimeout(hideMessage, 3000);
                    addLogEntry("Initial user data loaded", { status: "success", count: users.length -1 });
                }

            }
            // Catch block for error handling
            catch (error) {
                console.error("Failed to fetch initial user data from z.html:", error);
                showMessage(`Failed to load initial user data: ${error.message}. Please check the URL and content of z.html.`, 'error');
                addLogEntry("Initial user data fetch failed", { error: error.message });
            } finally {
                loadingIndicator.classList.add('hidden');
                loginButton.disabled = false;
                googleLoginButton.disabled = false;
            }
        }

        // --- Firestore Real-time Listeners ---
        function setupFirestoreListeners() {
            // Listen for changes in user roles
            onSnapshot(userRolesCollectionRef, (snapshot) => {
                const newRoles = {};
                snapshot.forEach(doc => {
                    newRoles[doc.id] = doc.data(); // doc.id will be the username
                });
                firestoreUserRoles = newRoles;
                console.log("Firestore: User Roles updated:", firestoreUserRoles);
                if (!userManagementPanel.classList.contains('hidden')) {
                    renderUserRolesTable(); // Re-render if the panel is open
                }
            }, (error) => {
                console.error("Firestore: Error listening to user roles:", error);
                showMessage("Error: Could not sync user roles from cloud.", 'error');
            });

            // Listen for changes in activity logs
            onSnapshot(activityLogsCollectionRef, (snapshot) => {
                const newLogs = [];
                snapshot.forEach(doc => {
                    newLogs.push({ id: doc.id, ...doc.data() }); // Include doc.id for potential deletion
                });
                firestoreActivityLogs = newLogs;
                console.log("Firestore: Activity Logs updated:", firestoreActivityLogs.length, "entries");
                populateLogFilterTypes(); // Update filter options based on new logs
                renderLogs(); // Re-render logs when data changes
            }, (error) => {
                console.error("Firestore: Error listening to activity logs:", error);
                showMessage("Error: Could not sync activity logs from cloud.", 'error');
            });
        }


        // Initialize all logic after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired. Script is running.');

            // Authenticate with Firebase and then set up application listeners/data fetches
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Firebase: Authenticated. User ID:", user.uid, "Provider:", user.providerData[0]?.providerId || 'N/A');
                    await fetchInitialUserData(); // Fetch initial user data from z.html
                    setupFirestoreListeners();    // Set up real-time Firestore listeners
                    firebaseAuthReady = true; // Set readiness to true AFTER listeners are set up

                    // Check for a saved login state in localStorage
                    const storedUser = localStorage.getItem('loggedInUser');
                    if (storedUser) {
                        try {
                            const loggedInUser = JSON.parse(storedUser);
                            // If localStorage has a user, and Firebase Auth also has a user,
                            // ensure they are consistent or use the Firebase one as primary truth.
                            // Here, we re-handle login to ensure display is based on Firebase Auth.
                            handleLoginSuccess(loggedInUser); // Use localStorage data for display
                        } catch (e) {
                            console.error("Error parsing stored user data from localStorage:", e);
                            localStorage.removeItem('loggedInUser'); // Clear invalid data
                            showMessage("Saved login data corrupted. Please log in again.", 'error');
                            addLogEntry("Corrupted saved login detected (localStorage)");
                        }
                    } else {
                        // If Firebase Auth has a user but localStorage doesn't,
                        // this means a new Firebase session (e.g., from direct Google login)
                        // or previous localStorage was cleared.
                        // Create a temporary user object from Firebase data for handleLoginSuccess.
                        const displayUser = {
                            username: user.email || user.uid,
                            name: user.displayName || user.email || 'Anonymous User',
                            profilePic: user.photoURL || 'https://placehold.co/50x50/cccccc/ffffff?text=U',
                            isAdmin: user.email === SECRET_ADMIN_USER.username // Simple admin check
                        };
                        handleLoginSuccess(displayUser);
                    }

                } else { // No Firebase user is currently authenticated
                    // Only attempt anonymous sign-in if not currently logging out
                    if (!isLoggingOut) {
                        console.log("Firebase: Not authenticated yet or signed out. Attempting anonymous sign-in.");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Firebase: Signed in with custom token (for Canvas environment).");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Firebase: Signed in anonymously (for general web deployment).");
                            }
                        } catch (error) {
                            console.error("Firebase: Anonymous/Custom authentication failed:", error);
                            showMessage(`Firebase authentication failed: ${error.message}. Firestore features may not work.`, 'error');
                        } finally {
                            firebaseAuthReady = true;
                            await fetchInitialUserData();
                            setupFirestoreListeners();
                        }
                    } else {
                        // If isLoggingOut is true, it means we just signed out manually.
                        // Do not automatically sign in anonymously; let the login form be displayed.
                        console.log("Firebase: User logged out manually. Not re-authenticating anonymously.");
                        firebaseAuthReady = true; // Still mark as ready so login form can be used
                        showPanel(loginForm); // Ensure login form is visible
                        logoutButton.classList.add('hidden'); // Ensure logout button is hidden
                        isLoggingOut = false; // Reset the flag
                    }
                }
            });
        });


        // Event listener for form submission (Email/Password or Z.html)
        loginForm.addEventListener('submit', async (event) => {
            console.log('Form submit event fired!');
            event.preventDefault(); // This is crucial to stop default browser form submission

            const enteredUsername = usernameInput.value.toLowerCase();
            const enteredPassword = passwordInput.value;

            addLogEntry("Login Attempt", { username: enteredUsername });

            if (!firebaseAuthReady) {
                showMessage("Firebase authentication is not ready yet. Please wait a moment and try again.", 'info');
                console.warn("Login attempt before Firebase authentication is ready.");
                return;
            }
            if (!auth.currentUser) {
                 showMessage("Firebase user session not established. Please refresh or try again.", 'error');
                 console.error("auth.currentUser is null during login form submission.");
                 addLogEntry("Login Failed: No Firebase user session", { username: enteredUsername });
                 return;
            }


            // Attempt admin login (local check for secret admin)
            if (enteredUsername === SECRET_ADMIN_USER.username && enteredPassword === SECRET_ADMIN_USER.password) {
                // For the SECRET_ADMIN_USER, we still primarily use the local check for simplicity.
                // If you want this admin to be a Firebase Auth user, you would create them in Firebase Auth
                // with an email (e.g., admin@yourdomain.com) and use signInWithEmailAndPassword.
                handleLoginSuccess(SECRET_ADMIN_USER);
                return;
            }

            // For other users, prioritize Firebase Email/Password Authentication
            if (enteredUsername.includes('@') && enteredUsername.includes('.')) { // Simple check for email format
                try {
                    console.log(`Attempting Firebase Email/Password login for: ${enteredUsername}`);
                    const userCredential = await signInWithEmailAndPassword(auth, enteredUsername, enteredPassword);
                    const firebaseUser = userCredential.user;
                    console.log("Firebase Email/Password login successful:", firebaseUser.uid);

                    let displayUser = users.find(u => u.username.toLowerCase() === enteredUsername) || {
                        username: firebaseUser.email,
                        name: firebaseUser.displayName || firebaseUser.email,
                        profilePic: firebaseUser.photoURL || 'https://placehold.co/50x50/cccccc/ffffff?text=U'
                    };
                    handleLoginSuccess(displayUser);
                    addLogEntry("Firebase Email/Password Login", { user: enteredUsername, firebaseUid: firebaseUser.uid });

                } catch (error) {
                    console.error("Firebase Email/Password login failed:", error);
                    let errorMessage = 'Firebase login failed. Please check your email and password.';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Invalid email or password.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email format for Firebase login.';
                    }
                    showMessage(errorMessage, 'error');
                    addLogEntry("Firebase Email/Password Login Failed", { user: enteredUsername, error: error.message });
                }
            } else {
                // Fallback to z.html local password check if it's not an email-like username
                let foundUserFromZHtml = users.find(
                    user => user.username.toLowerCase() === enteredUsername && user.password === enteredPassword
                );
                if (foundUserFromZHtml) {
                    console.log('Login successful via z.html (insecure) for user:', foundUserFromZHtml.username);
                    // For z.html users, we assume an anonymous Firebase Auth session exists.
                    // The handleLoginSuccess will then store their z.html details with this anonymous UID.
                    handleLoginSuccess(foundUserFromZHtml);
                    addLogEntry("Local Z.html Login (Insecure)", { user: enteredUsername });
                } else {
                    showMessage('Invalid username or password.', 'error');
                    addLogEntry("Login failed", { username: enteredUsername, reason: "Invalid credentials (no Firebase email or z.html match)" });
                }
            }
        });

        // Event listener for Google Login Button
        googleLoginButton.addEventListener('click', async () => {
            console.log('Google Login button clicked.');
            addLogEntry("Google Login Attempt");

            if (!firebaseAuthReady) {
                showMessage("Firebase authentication is not ready yet. Please wait a moment and try again.", 'info');
                return;
            }
            
            // It's possible that onAuthStateChanged signed in anonymously, but then the user clicks Google Login.
            // signInWithPopup usually handles linking the anonymous account automatically,
            // but explicitly ensuring auth.currentUser here provides clearer intent.
            if (!auth.currentUser) {
                showMessage("Firebase user session not established. Please refresh or try again.", 'error');
                console.error("auth.currentUser is null before Google sign-in popup.");
                addLogEntry("Google Login Failed: No Firebase user session", {});
                return;
            }

            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                console.log("Google Sign-In successful:", user);

                // Try to find matching user details from z.html or use Firebase user info
                let displayUser = users.find(u => u.username.toLowerCase() === user.email?.toLowerCase()) || {
                    username: user.email,
                    name: user.displayName,
                    profilePic: user.photoURL
                };
                handleLoginSuccess(displayUser);
                addLogEntry("Google Login Success", { user: user.email || user.uid });

            } catch (error) {
                console.error("Google Sign-In failed:", error);
                let errorMessage = "Google sign-in failed.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google login window was closed.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Popup blocked or already open.";
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                     errorMessage = `An account already exists with this email using a different login method.`;
                     console.warn(errorMessage, "Provider ID:", error.customData.email, error.credential.providerId);
                }
                showMessage(errorMessage, 'error');
                addLogEntry("Google Login Failed", { error: error.message });
            }
        });


        // Event listener for logout button
        logoutButton.addEventListener('click', handleLogout);

        // --- Admin Panel Button Event Listeners ---
        manageUsersButton.addEventListener('click', () => {
            showPanel(userManagementPanel);
            renderUserRolesTable();
            addLogEntry("User Management Panel Opened", { user: SECRET_ADMIN_USER.username });
        });

        hideUserManagementButton.addEventListener('click', () => {
            showPanel(adminPanel); // Go back to admin panel
        });

        saveUserRolesButton.addEventListener('click', collectAndSaveRoles);


        // Event listeners for log viewer buttons
        viewLogsButton.addEventListener('click', () => {
            showPanel(logViewer);
            populateLogFilterTypes();
            renderLogs();
            addLogEntry("View Logs Button Clicked", { user: localStorage.getItem('loggedInUser') ? JSON.parse(localStorage.getItem('loggedInUser')).username : 'Unknown' });
        });

        hideLogsButton.addEventListener('click', () => {
            showPanel(adminPanel); // Go back to admin panel
        });

        clearLogsButton.addEventListener('click', clearLogs);

        // Event listeners for log filtering and sorting
        logFilterType.addEventListener('change', renderLogs);
        logSearchText.addEventListener('input', renderLogs);
        logSortOrderRadios.forEach(radio => {
            radio.addEventListener('change', renderLogs);
        });

        // --- Account Management Button Event Listeners ---
        manageAccountButton.addEventListener('click', () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser) {
                showPanel(accountManagementPanel);
                renderAccountManagementPanel(loggedInUser); // Pass localStorage data, but panel will prioritize Firebase Auth
                addLogEntry("Account Management Panel Opened", { user: loggedInUser.username });
            } else {
                showMessage("Please log in to manage your account.", 'info');
            }
        });

        hideAccountManagementButton.addEventListener('click', () => {
            // If admin is logged in, return to admin panel, otherwise to login form
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser && loggedInUser.isAdmin) {
                showPanel(adminPanel);
            } else {
                // If not admin, they are a regular user. We should send them back to the
                // account management panel's equivalent of "main app screen", which for now
                // is just the login form itself, or perhaps a placeholder main app screen.
                showPanel(loginForm); // Or navigate to a 'main_app_page.html'
            }
        });

        linkGoogleAccountButton.addEventListener('click', handleGoogleLink);

    </script>
</body>
</html>
